<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>2.5D Mobile Fishing</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: sans-serif; touch-action: none; }
        
        /* UI Overlay */
        #ui {
            position: absolute;
            top: 10px; left: 10px;
            color: white; background: rgba(0,0,0,0.6);
            padding: 8px; border-radius: 5px;
            pointer-events: none; z-index: 10;
        }

        /* Virtual Controls */
        #controls {
            position: absolute;
            bottom: 30px; left: 0; right: 0;
            display: flex; justify-content: space-between;
            padding: 0 30px; pointer-events: none;
            z-index: 20;
        }

        .d-pad {
            width: 120px; height: 120px;
            background: rgba(255,255,255,0.2);
            border-radius: 50%; position: relative;
            pointer-events: auto;
        }

        .action-btn {
            width: 80px; height: 80px;
            background: rgba(255, 50, 50, 0.6);
            border: 4px solid white; border-radius: 50%;
            color: white; font-weight: bold;
            display: flex; align-items: center; justify-content: center;
            pointer-events: auto; user-select: none;
        }

        .action-btn:active { background: rgba(255, 50, 50, 0.9); transform: scale(0.9); }

        #msg { color: #00ff00; font-weight: bold; }
    </style>
</head>
<body>

    <div id="ui">
        <div id="msg">Explore the Town</div>
    </div>

    <div id="controls">
        <div class="d-pad" id="joystick">
            <div style="position:absolute; top:50%; left:50%; transform:translate(-50%, -50%); color:white; opacity:0.5;">MOVE</div>
        </div>
        <div class="action-btn" id="fishBtn">FISH</div>
    </div>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';

        // --- SCENE SETUP ---
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x3a9e3a);

        const aspect = window.innerWidth / window.innerHeight;
        const d = 5;
        const camera = new THREE.OrthographicCamera(-d * aspect, d * aspect, d, -d, 0.1, 1000);
        camera.position.set(10, 10, 10);
        camera.lookAt(0, 0, 0);

        const renderer = new THREE.WebGLRenderer({ antialias: false });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(window.devicePixelRatio);
        document.body.appendChild(renderer.domElement);

        // --- TOWN ---
        const water = new THREE.Mesh(
            new THREE.PlaneGeometry(4, 6),
            new THREE.MeshBasicMaterial({ color: 0x0077be })
        );
        water.rotation.x = -Math.PI / 2;
        water.position.set(4, 0.01, 0);
        scene.add(water);

        const house = new THREE.Mesh(
            new THREE.BoxGeometry(2, 2, 2),
            new THREE.MeshBasicMaterial({ color: 0x8b4513 })
        );
        house.position.set(-3, 1, -2);
        scene.add(house);

        // --- PLAYER ---
        const canvas = document.createElement('canvas');
        canvas.width = 64; canvas.height = 64;
        const ctx = canvas.getContext('2d');
        ctx.fillStyle = "red"; ctx.fillRect(16, 0, 32, 32); 
        ctx.fillStyle = "white"; ctx.fillRect(16, 32, 32, 32);
        const trainerTexture = new THREE.CanvasTexture(canvas);
        trainerTexture.magFilter = THREE.NearestFilter;
        const player = new THREE.Sprite(new THREE.SpriteMaterial({ map: trainerTexture }));
        player.position.y = 0.8;
        scene.add(player);

        const bobber = new THREE.Mesh(new THREE.SphereGeometry(0.1), new THREE.MeshBasicMaterial({ color: 0xffffff }));
        bobber.visible = false;
        scene.add(bobber);

        // --- INPUT & MOBILE LOGIC ---
        let gameState = 'walking';
        const moveVector = { x: 0, z: 0 };
        const msgEl = document.getElementById('msg');

        // Virtual Joystick Logic
        const joystick = document.getElementById('joystick');
        joystick.addEventListener('touchstart', handleMove);
        joystick.addEventListener('touchmove', handleMove);
        joystick.addEventListener('touchend', () => { moveVector.x = 0; moveVector.z = 0; });

        function handleMove(e) {
            e.preventDefault();
            const touch = e.touches[0];
            const rect = joystick.getBoundingClientRect();
            const centerX = rect.left + rect.width / 2;
            const centerY = rect.top + rect.height / 2;
            // Calculate direction from center of D-Pad
            moveVector.x = (touch.clientX - centerX) / 50;
            moveVector.z = (touch.clientY - centerY) / 50;
        }

        // Fishing Action
        const fishBtn = document.getElementById('fishBtn');
        fishBtn.addEventListener('touchstart', (e) => {
            e.preventDefault();
            handleFishingAction();
        });

        function handleFishingAction() {
            if (gameState === 'walking') {
                if (player.position.distanceTo(water.position) < 4) {
                    gameState = 'waiting';
                    msgEl.innerText = "Casting... Wait for red flash!";
                    bobber.position.set(player.position.x + 1.2, 0.1, player.position.z);
                    bobber.visible = true;
                    bobber.material.color.set(0xffffff);

                    setTimeout(() => {
                        if (gameState === 'waiting') {
                            gameState = 'bite';
                            msgEl.innerText = "TAP NOW!!";
                            bobber.material.color.set(0xff0000);
                        }
                    }, 1000 + Math.random() * 3000);
                }
            } else if (gameState === 'bite') {
                msgEl.innerText = "Nice catch!";
                resetFishing();
            } else if (gameState === 'waiting') {
                msgEl.innerText = "Too early!";
                resetFishing();
            }
        }

        function resetFishing() {
            gameState = 'cooldown';
            bobber.visible = false;
            setTimeout(() => {
                gameState = 'walking';
                msgEl.innerText = "Explore the Town";
            }, 1500);
        }

        // --- MAIN LOOP ---
        function animate() {
            requestAnimationFrame(animate);

            if (gameState === 'walking') {
                // Clamp movement speed
                const speed = 0.12;
                player.position.x += Math.max(-1, Math.min(1, moveVector.x)) * speed;
                player.position.z += Math.max(-1, Math.min(1, moveVector.z)) * speed;
            }

            camera.position.x = player.position.x + 10;
            camera.position.z = player.position.z + 10;
            renderer.render(scene, camera);
        }

        window.addEventListener('resize', () => {
            const aspect = window.innerWidth / window.innerHeight;
            camera.left = -d * aspect; camera.right = d * aspect;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        animate();
    </script>
</body>
</html>
