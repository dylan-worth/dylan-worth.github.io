<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>2.5D Town Fishing Hole</title>
    <style>
        body { margin: 0; overflow: hidden; background: #222; font-family: 'Courier New', monospace; touch-action: none; }
        
        #ui {
            position: absolute;
            top: 20px; width: 100%;
            text-align: center;
            color: white;
            z-index: 10;
            pointer-events: none;
        }

        #action-container {
            position: absolute;
            bottom: 50px; width: 100%;
            display: flex; justify-content: center;
            z-index: 20;
        }

        .btn {
            padding: 20px 40px;
            font-size: 20px;
            background: #ff4444;
            color: white;
            border: 4px solid white;
            border-radius: 10px;
            cursor: pointer;
            pointer-events: auto;
            box-shadow: 0 5px 0 #880000;
        }

        .btn:active { transform: translateY(4px); box-shadow: none; }

        #status { font-size: 24px; text-shadow: 2px 2px #000; }
        #score { font-size: 18px; margin-top: 10px; color: #ffeb3b; }
    </style>
</head>
<body>

    <div id="ui">
        <div id="status">The Town Fishing Hole</div>
        <div id="score">Fish Caught: 0</div>
    </div>

    <div id="action-container">
        <button class="btn" id="fishBtn">CAST LINE</button>
    </div>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';

        // --- SCENE & PIXEL-PERFECT CAMERA ---
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x6eb5ff); // Clear sky

        const aspect = window.innerWidth / window.innerHeight;
        const d = 5;
        const camera = new THREE.OrthographicCamera(-d * aspect, d * aspect, d, -d, 0.1, 1000);
        camera.position.set(10, 8, 10);
        camera.lookAt(0, 0, 0);

        const renderer = new THREE.WebGLRenderer({ antialias: false });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(window.devicePixelRatio);
        document.body.appendChild(renderer.domElement);

        // --- GENERATING THE TOWN BACKGROUND ---
        // Grass Base
        const grass = new THREE.Mesh(new THREE.PlaneGeometry(20, 20), new THREE.MeshBasicMaterial({ color: 0x4caf50 }));
        grass.rotation.x = -Math.PI / 2;
        scene.add(grass);

        // The Fishing Pond (Right in front of player)
        const pond = new THREE.Mesh(new THREE.PlaneGeometry(6, 4), new THREE.MeshBasicMaterial({ color: 0x00aaff }));
        pond.rotation.x = -Math.PI / 2;
        pond.position.set(0, 0.02, 2);
        scene.add(pond);

        // Decorative Buildings (Town feel)
        function createBuilding(x, z, color, h) {
            const b = new THREE.Mesh(new THREE.BoxGeometry(2, h, 2), new THREE.MeshBasicMaterial({ color: color }));
            b.position.set(x, h/2, z);
            scene.add(b);
        }
        createBuilding(-4, -2, 0xba68c8, 3); // Purple house
        createBuilding(4, -3, 0xffb74d, 2);  // Orange house
        createBuilding(0, -5, 0xef5350, 4);  // Red tall building

        // --- STATIC PLAYER (TRAINER) ---
        const canvas = document.createElement('canvas');
        canvas.width = 64; canvas.height = 64;
        const ctx = canvas.getContext('2d');
        ctx.fillStyle = "red"; ctx.fillRect(16, 0, 32, 24); // Hat
        ctx.fillStyle = "#ffcc99"; ctx.fillRect(16, 24, 32, 8); // Face
        ctx.fillStyle = "blue"; ctx.fillRect(12, 32, 40, 32); // Body
        
        const trainerTex = new THREE.CanvasTexture(canvas);
        trainerTex.magFilter = THREE.NearestFilter;
        const player = new THREE.Sprite(new THREE.SpriteMaterial({ map: trainerTex }));
        player.position.set(0, 0.8, -1); // Centered, looking at pond
        scene.add(player);

        // Bobber
        const bobber = new THREE.Mesh(new THREE.SphereGeometry(0.12), new THREE.MeshBasicMaterial({ color: 0xffffff }));
        bobber.visible = false;
        scene.add(bobber);

        // --- FISHING LOGIC ---
        let state = 'idle';
        let caughtCount = 0;
        const statusEl = document.getElementById('status');
        const scoreEl = document.getElementById('score');
        const btn = document.getElementById('fishBtn');

        function startFishing() {
            if (state !== 'idle') return;

            state = 'casting';
            btn.innerText = "WAITING...";
            statusEl.innerText = "Line cast into the pond...";
            
            // Show bobber in pond
            bobber.position.set(0, 0.1, 2);
            bobber.visible = true;
            bobber.material.color.set(0xffffff);

            // Random delay for a bite
            const delay = 2000 + Math.random() * 3000;
            setTimeout(() => {
                if (state === 'casting') {
                    state = 'bite';
                    btn.innerText = "REEL IN!!";
                    statusEl.innerText = "Something's biting!";
                    bobber.material.color.set(0xff0000);
                    bobber.position.y = -0.1; // Sinks
                }
            }, delay);
        }

        function reelIn() {
            if (state === 'bite') {
                caughtCount++;
                scoreEl.innerText = `Fish Caught: ${caughtCount}`;
                statusEl.innerText = "You caught a town fish!";
                endSession();
            } else if (state === 'casting') {
                statusEl.innerText = "Too early! The fish fled.";
                endSession();
            }
        }

        function endSession() {
            state = 'cooldown';
            btn.innerText = "---";
            bobber.visible = false;
            setTimeout(() => {
                state = 'idle';
                btn.innerText = "CAST LINE";
                statusEl.innerText = "The Town Fishing Hole";
            }, 2000);
        }

        btn.addEventListener('touchstart', (e) => { e.preventDefault(); handleInput(); });
        btn.addEventListener('click', handleInput);

        function handleInput() {
            if (state === 'idle') startFishing();
            else if (state === 'bite' || state === 'casting') reelIn();
        }

        // --- ANIMATION LOOP ---
        function animate() {
            requestAnimationFrame(animate);
            // Gentle bobbing effect for the water/world
            pond.position.y = 0.02 + Math.sin(Date.now() * 0.002) * 0.02;
            renderer.render(scene, camera);
        }

        window.addEventListener('resize', () => {
            const aspect = window.innerWidth / window.innerHeight;
            camera.left = -d * aspect; camera.right = d * aspect;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        animate();
    </script>
</body>
</html>
