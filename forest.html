<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Forest Explorer</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: 'Courier New', sans-serif; user-select: none; }
        canvas { display: block; width: 100vw; height: 100vh; touch-action: none; }

        /* --- UI LAYER --- */
        #ui-layer {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none;
        }

        /* HEADER */
        #header {
            position: absolute;
            top: 20px; width: 100%;
            text-align: center;
            color: white;
            text-shadow: 0 2px 4px rgba(0,0,0,0.8);
            z-index: 10;
        }
        h1 { margin: 0; font-size: 20px; letter-spacing: 2px; }

        /* INVENTORY BAR (Top Left) */
        #inventory {
            position: absolute;
            top: 20px; left: 20px;
            display: flex;
            gap: 10px;
            pointer-events: auto;
        }
        .inv-slot {
            background: rgba(0,0,0,0.6);
            border: 2px solid #5d4037;
            color: #e6c86e;
            width: 50px; height: 50px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            font-size: 10px;
            cursor: pointer;
        }
        .inv-slot.active { border-color: #e6c86e; background: rgba(230, 200, 110, 0.2); }
        .inv-icon { font-size: 20px; margin-bottom: 2px; }

        /* ZOOM CONTROLS (Right Side) */
        #zoom-controls {
            position: absolute;
            top: 50%; right: 20px;
            transform: translateY(-50%);
            display: flex;
            flex-direction: column;
            gap: 10px;
            pointer-events: auto;
        }
        .hud-btn {
            width: 40px; height: 40px;
            background: rgba(255,255,255,0.1);
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            color: white;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }
        .hud-btn:active { background: rgba(255,255,255,0.3); }

        /* ACTION BUTTON (Bottom Right) */
        #action-btn {
            position: absolute;
            bottom: 50px; right: 40px;
            width: 80px; height: 80px;
            background: #e6c86e;
            border: 4px solid #5d4037;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #3e2723;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
            pointer-events: auto;
            transition: all 0.2s;
            opacity: 0.5; /* Dimmed when inactive */
        }
        #action-btn.ready { opacity: 1; transform: scale(1.1); cursor: pointer; }
        #action-btn:active { transform: scale(0.95); }

        /* JOYSTICK (Bottom Left) */
        #joystick-zone {
            position: absolute;
            bottom: 40px; left: 40px;
            width: 120px; height: 120px;
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            pointer-events: auto;
        }
        #stick {
            position: absolute;
            top: 50%; left: 50%;
            width: 50px; height: 50px;
            background: rgba(230, 200, 110, 0.8);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
        }

        /* MODAL */
        #interaction-modal {
            position: absolute;
            top: 20%; left: 50%;
            transform: translate(-50%, -50%) scale(0.8);
            background: rgba(20, 20, 20, 0.95);
            border: 2px solid #e6c86e;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            color: #e6c86e;
            opacity: 0;
            transition: all 0.3s;
            pointer-events: none;
        }
        #interaction-modal.active { opacity: 1; transform: translate(-50%, -50%) scale(1); pointer-events: auto; }
        .btn-visit { margin-top:10px; display:inline-block; padding:8px 16px; background:#e6c86e; color:black; text-decoration:none; border-radius:4px; }

    </style>
    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js"
            }
        }
    </script>
</head>
<body>

    <div id="ui-layer">
        <div id="header">
            <h1>FOREST NAVIGATOR</h1>
        </div>

        <div id="inventory">
            <div class="inv-slot active" id="btn-flashlight" onclick="toggleFlashlight()">
                <div class="inv-icon">ðŸ”¦</div>
                <div id="flash-status">ON</div>
            </div>
            <div class="inv-slot">
                <div class="inv-icon">ðŸªµ</div>
                <div id="wood-count">0</div>
            </div>
        </div>

        <div id="zoom-controls">
            <div class="hud-btn" onclick="adjustZoom(-5)">+</div>
            <div class="hud-btn" onclick="adjustZoom(5)">-</div>
        </div>

        <div id="action-btn" onclick="performAction()">
            <span id="action-text">...</span>
        </div>

        <div id="interaction-modal">
            <h2 id="modal-title">TITLE</h2>
            <p id="modal-desc">Desc</p>
            <a href="#" id="modal-link" class="btn-visit">VISIT</a>
        </div>

        <div id="joystick-zone">
            <div id="stick"></div>
        </div>
    </div>

    <script type="module">
        import * as THREE from 'three';

        // --- GAME STATE ---
        const STATE = {
            wood: 0,
            flashlight: true,
            zoom: 15, // Camera distance
            nearbyTree: null, // Object reference
            nearbyPOI: null // Object reference
        };

        const POIS = [
            { label: "ABOUT", desc: "Who am I?", color: 0x3498db, x: 0, z: -15, link: "/about" },
            { label: "WORK", desc: "My projects.", color: 0xe74c3c, x: -15, z: 8, link: "/projects" },
            { label: "CONTACT", desc: "Get in touch.", color: 0x9b59b6, x: 15, z: 8, link: "/contact" }
        ];

        // --- SCENE SETUP ---
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x111122);
        scene.fog = new THREE.Fog(0x111122, 10, 50);

        const camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 100);
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.shadowMap.enabled = true;
        document.body.appendChild(renderer.domElement);

        // --- LIGHTING ---
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.2); 
        scene.add(ambientLight);

        const moonLight = new THREE.DirectionalLight(0xaaccff, 0.3);
        moonLight.position.set(20, 50, -20);
        moonLight.castShadow = true;
        scene.add(moonLight);

        // Player Flashlight
        const playerLight = new THREE.SpotLight(0xffaa00, 5);
        playerLight.angle = Math.PI / 4;
        playerLight.penumbra = 0.5;
        playerLight.decay = 2;
        playerLight.distance = 30;
        playerLight.castShadow = true;
        scene.add(playerLight);
        scene.add(playerLight.target); // Essential for spotlight targeting

        // --- OBJECTS ---
        
        // Ground
        const ground = new THREE.Mesh(
            new THREE.PlaneGeometry(100, 100),
            new THREE.MeshStandardMaterial({ color: 0x1b3b22 })
        );
        ground.rotation.x = -Math.PI / 2;
        ground.receiveShadow = true;
        scene.add(ground);

        // Player
        const player = new THREE.Mesh(
            new THREE.CapsuleGeometry(0.4, 0.8, 4, 8),
            new THREE.MeshStandardMaterial({ color: 0xffaa00 })
        );
        player.position.set(0, 0.6, 5);
        player.castShadow = true;
        scene.add(player);

        // Arrays to track interactive objects
        let treeObjects = [];
        let poiObjects = [];

        function createTree(x, z, scale = 1) {
            const group = new THREE.Group();
            
            // Trunk
            const trunk = new THREE.Mesh(
                new THREE.CylinderGeometry(0.15 * scale, 0.3 * scale, 1.5 * scale, 6),
                new THREE.MeshStandardMaterial({ color: 0x3e2723 })
            );
            trunk.position.y = (0.75 * scale);
            trunk.castShadow = true;
            group.add(trunk);

            // Leaves
            const leaves = new THREE.Mesh(
                new THREE.ConeGeometry(1 * scale, 2 * scale, 6),
                new THREE.MeshStandardMaterial({ color: 0x145a32 })
            );
            leaves.position.y = (2 * scale);
            leaves.castShadow = true;
            group.add(leaves);

            group.position.set(x, 0, z);
            
            // Animation data (for growing trees)
            group.userData = { targetScale: scale, currentScale: 0.1, isGrowing: scale === 0.1 };
            if(group.userData.isGrowing) group.scale.set(0.1, 0.1, 0.1);

            scene.add(group);
            treeObjects.push(group);
        }

        // Initial Forest Generation
        for(let i=0; i<50; i++) {
            let x = (Math.random() - 0.5) * 80;
            let z = (Math.random() - 0.5) * 80;
            if(Math.sqrt(x*x + z*z) > 6) createTree(x, z);
        }

        // Create Signposts (POIs)
        POIS.forEach(data => {
            const group = new THREE.Group();
            group.position.set(data.x, 0, data.z);

            const post = new THREE.Mesh(new THREE.BoxGeometry(0.2, 2, 0.2), new THREE.MeshStandardMaterial({ color: 0x5d4037 }));
            post.position.y = 1;
            group.add(post);

            const board = new THREE.Mesh(new THREE.BoxGeometry(1.5, 0.8, 0.1), new THREE.MeshStandardMaterial({ color: data.color }));
            board.position.set(0, 1.8, 0.1);
            group.add(board);
            
            // Light to make it pop
            const beacon = new THREE.PointLight(data.color, 1, 6);
            beacon.position.y = 2;
            group.add(beacon);

            group.userData = data; // Store data for the modal
            scene.add(group);
            poiObjects.push(group);
        });

        // --- CONTROLS & LOGIC ---

        // Expose functions to window for HTML buttons
        window.adjustZoom = (amount) => {
            STATE.zoom += amount;
            // Clamp zoom
            if(STATE.zoom < 8) STATE.zoom = 8;
            if(STATE.zoom > 30) STATE.zoom = 30;
        };

        window.toggleFlashlight = () => {
            STATE.flashlight = !STATE.flashlight;
            playerLight.intensity = STATE.flashlight ? 5 : 0;
            
            const btn = document.getElementById('btn-flashlight');
            const txt = document.getElementById('flash-status');
            
            if(STATE.flashlight) {
                btn.classList.add('active');
                txt.innerText = "ON";
            } else {
                btn.classList.remove('active');
                txt.innerText = "OFF";
            }
        };

        window.performAction = () => {
            const btn = document.getElementById('action-btn');
            
            // If nearby tree -> CHOP
            if (STATE.nearbyTree) {
                // Remove tree
                scene.remove(STATE.nearbyTree);
                treeObjects = treeObjects.filter(t => t !== STATE.nearbyTree);
                STATE.nearbyTree = null;
                
                // Add Wood
                STATE.wood++;
                document.getElementById('wood-count').innerText = STATE.wood;
                
                // Feedback
                btn.style.transform = "scale(0.8)";
                setTimeout(() => btn.style.transform = "scale(1)", 100);
            } 
            // If NO tree and have Wood -> PLANT
            else if (STATE.wood > 0) {
                // Plant slightly in front of player
                const plantPos = player.position.clone();
                const dir = new THREE.Vector3(0,0,1).applyAxisAngle(new THREE.Vector3(0,1,0), player.rotation.y);
                plantPos.add(dir.multiplyScalar(2));
                
                // Check if too close to another tree
                let tooClose = false;
                treeObjects.forEach(t => { if(t.position.distanceTo(plantPos) < 2) tooClose = true; });
                
                if(!tooClose) {
                    createTree(plantPos.x, plantPos.z, 1);
                    // Tree starts small via animation logic in createTree
                    treeObjects[treeObjects.length-1].userData.isGrowing = true;
                    
                    STATE.wood--;
                    document.getElementById('wood-count').innerText = STATE.wood;
                }
            }
        };

        // Joystick Logic
        const stick = { x: 0, y: 0 };
        const stickEl = document.getElementById('stick');
        const zone = document.getElementById('joystick-zone');

        function handleInput(cx, cy, end) {
            if (end) {
                stick.x = 0; stick.y = 0;
                stickEl.style.transform = `translate(-50%, -50%)`;
                return;
            }
            const rect = zone.getBoundingClientRect();
            const center = { x: rect.left + rect.width/2, y: rect.top + rect.height/2 };
            let dx = cx - center.x; 
            let dy = cy - center.y;
            const dist = Math.sqrt(dx*dx + dy*dy);
            const max = 40;
            if (dist > max) { dx *= max/dist; dy *= max/dist; }
            stickEl.style.transform = `translate(calc(-50% + ${dx}px), calc(-50% + ${dy}px))`;
            stick.x = dx / max; stick.y = dy / max;
        }

        zone.addEventListener('touchmove', e => { e.preventDefault(); handleInput(e.touches[0].clientX, e.touches[0].clientY); });
        zone.addEventListener('touchend', () => handleInput(0,0,true));
        // Mouse support for testing
        let dragging = false;
        zone.addEventListener('mousedown', e => { dragging=true; handleInput(e.clientX, e.clientY); });
        window.addEventListener('mousemove', e => { if(dragging) handleInput(e.clientX, e.clientY); });
        window.addEventListener('mouseup', () => { dragging=false; handleInput(0,0,true); });

        // --- MAIN LOOP ---
        const actionBtn = document.getElementById('action-btn');
        const actionText = document.getElementById('action-text');
        const modal = document.getElementById('interaction-modal');

        function animate() {
            requestAnimationFrame(animate);

            // 1. Player Movement
            if (Math.abs(stick.x) > 0.1 || Math.abs(stick.y) > 0.1) {
                const speed = 0.15;
                player.position.x += stick.x * speed;
                player.position.z += stick.y * speed;
                player.rotation.y = Math.atan2(-stick.x, -stick.y); // Face direction
            }

            // 2. Light Follow
            playerLight.position.set(player.position.x, player.position.y + 2, player.position.z);
            // Spotlight target follows slightly ahead of player
            const targetPos = new THREE.Vector3(player.position.x + (stick.x * 5), 0, player.position.z + (stick.y * 5));
            playerLight.target.position.lerp(targetPos, 0.1);

            // 3. Camera Follow (With Zoom)
            const camOffset = new THREE.Vector3(0, STATE.zoom, STATE.zoom - 5); // Angle changes slightly with zoom
            camera.position.lerp(player.position.clone().add(camOffset), 0.05);
            camera.lookAt(player.position);

            // 4. Tree Growth Animation
            treeObjects.forEach(t => {
                if(t.userData.isGrowing) {
                    t.userData.currentScale += 0.02;
                    t.scale.setScalar(t.userData.currentScale);
                    if(t.userData.currentScale >= 1) t.userData.isGrowing = false;
                }
            });

            // 5. Interaction Check (Trees)
            let closestTree = null;
            let minDist = 2.0;

            treeObjects.forEach(t => {
                const dist = player.position.distanceTo(t.position);
                if(dist < minDist) {
                    minDist = dist;
                    closestTree = t;
                }
            });

            STATE.nearbyTree = closestTree;

            // UI Update for Action Button
            if (STATE.nearbyTree) {
                actionBtn.classList.add('ready');
                actionBtn.style.backgroundColor = '#e74c3c'; // Red for chop
                actionText.innerText = "CHOP";
            } else if (STATE.wood > 0) {
                actionBtn.classList.add('ready');
                actionBtn.style.backgroundColor = '#27ae60'; // Green for plant
                actionText.innerText = "PLANT";
            } else {
                actionBtn.classList.remove('ready');
                actionBtn.style.backgroundColor = '#e6c86e';
                actionText.innerText = "...";
            }

            // 6. Interaction Check (POIs)
            let nearPoi = false;
            poiObjects.forEach(poi => {
                const dist = player.position.distanceTo(poi.position);
                if (dist < 3) {
                    nearPoi = true;
                    if (STATE.nearbyPOI !== poi) {
                        STATE.nearbyPOI = poi;
                        document.getElementById('modal-title').innerText = poi.userData.label;
                        document.getElementById('modal-desc').innerText = poi.userData.desc;
                        document.getElementById('modal-link').href = poi.userData.link;
                        modal.classList.add('active');
                    }
                }
            });
            if (!nearPoi) {
                modal.classList.remove('active');
                STATE.nearbyPOI = null;
            }

            renderer.render(scene, camera);
        }

        // Resize
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        animate();

    </script>
</body>
</html>
