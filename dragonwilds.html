<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Dragon Wilds Mobile</title>
    <style>
        body { margin: 0; overflow: hidden; font-family: 'Cinzel', serif; touch-action: none; /* Disables browser scrolling */ }
        canvas { display: block; }

        /* --- REGION UI --- */
        #ui-layer {
            position: absolute;
            top: 15%; /* Higher up to clear center screen */
            width: 100%;
            display: flex;
            justify-content: center;
            pointer-events: none;
            opacity: 0;
            transition: opacity 1s ease-in;
            z-index: 10;
        }
        
        #region-box {
            background: linear-gradient(90deg, transparent, rgba(0, 0, 0, 0.8), transparent);
            padding: 10px 20px;
            border-top: 1px solid #d4af37;
            border-bottom: 1px solid #d4af37;
            color: white;
            text-align: center;
            transform: scale(0.8);
            transition: transform 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            width: 80%; /* Don't span full width on desktop, but wide on mobile */
            max-width: 400px;
        }

        h1 { margin: 0; font-size: 0.8rem; letter-spacing: 2px; text-transform: uppercase; color: #bbb; }
        h2 { margin: 2px 0 0 0; font-size: 1.5rem; color: #d4af37; text-shadow: 0 0 5px #d4af37; }
        
        .visible { opacity: 1 !important; }
        .pop-in { transform: scale(1) !important; }

        /* --- MOBILE CONTROLS (D-PAD) --- */
        #controls-layer {
            position: absolute;
            bottom: 20px;
            left: 20px;
            width: 150px;
            height: 150px;
            z-index: 20;
            /* Only show on touch devices or small screens if preferred, 
               but keeping visible here for desktop testing too */
        }

        .d-pad-btn {
            position: absolute;
            width: 50px;
            height: 50px;
            background: rgba(255, 255, 255, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            backdrop-filter: blur(4px);
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            color: white;
            user-select: none;
            cursor: pointer;
            transition: background 0.1s;
        }
        
        .d-pad-btn:active, .d-pad-btn.active { background: rgba(212, 175, 55, 0.5); }

        /* D-Pad Positioning */
        #btn-up { top: 0; left: 50px; }
        #btn-down { bottom: 0; left: 50px; }
        #btn-left { top: 50px; left: 0; }
        #btn-right { top: 50px; right: 0; }

        /* PC hint hidden on small screens */
        #pc-hint {
            position: absolute;
            bottom: 10px;
            right: 10px;
            color: rgba(255,255,255,0.5);
            font-size: 12px;
            font-family: sans-serif;
            pointer-events: none;
        }
        @media (max-width: 600px) {
            #pc-hint { display: none; }
            h2 { font-size: 1.2rem; }
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&display=swap" rel="stylesheet">
</head>
<body>

<div id="ui-layer">
    <div id="region-box">
        <h1>Region Discovered</h1>
        <h2>TEMPLE WOODS</h2>
    </div>
</div>

<div id="controls-layer">
    <div class="d-pad-btn" id="btn-up" data-key="w">▲</div>
    <div class="d-pad-btn" id="btn-left" data-key="a">◀</div>
    <div class="d-pad-btn" id="btn-right" data-key="d">▶</div>
    <div class="d-pad-btn" id="btn-down" data-key="s">▼</div>
</div>

<div id="pc-hint">WASD / ARROWS also work</div>

<script type="importmap">
  {
    "imports": {
      "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
      "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
    }
  }
</script>

<script type="module">
    import * as THREE from 'three';

    // --- 1. SETUP ---
    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0x87CEEB); 
    scene.fog = new THREE.Fog(0x87CEEB, 10, 50);

    const camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
    const renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.shadowMap.enabled = true;
    renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2)); // Optimize performance for mobile
    document.body.appendChild(renderer.domElement);

    // --- 2. LIGHTING ---
    const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
    scene.add(ambientLight);

    const dirLight = new THREE.DirectionalLight(0xffdfba, 1.5);
    dirLight.position.set(10, 20, 10);
    dirLight.castShadow = true;
    dirLight.shadow.mapSize.width = 1024; // Lower res shadows for mobile perf
    dirLight.shadow.mapSize.height = 1024;
    scene.add(dirLight);

    // --- 3. ENVIRONMENT ---
    const planeGeo = new THREE.PlaneGeometry(200, 200);
    const planeMat = new THREE.MeshStandardMaterial({ color: 0x55aa55 });
    const ground = new THREE.Mesh(planeGeo, planeMat);
    ground.rotation.x = -Math.PI / 2;
    ground.receiveShadow = true;
    scene.add(ground);

    // Simple Castle Arch
    const wallMat = new THREE.MeshStandardMaterial({ color: 0x444444 });
    const wallGeo = new THREE.BoxGeometry(4, 6, 1);
    const leftWall = new THREE.Mesh(wallGeo, wallMat);
    leftWall.position.set(-3, 3, 0);
    leftWall.castShadow = true;
    scene.add(leftWall);

    const rightWall = new THREE.Mesh(wallGeo, wallMat);
    rightWall.position.set(3, 3, 0);
    rightWall.castShadow = true;
    scene.add(rightWall);

    const topWall = new THREE.Mesh(new THREE.BoxGeometry(10, 2, 1), wallMat);
    topWall.position.set(0, 7, 0);
    topWall.castShadow = true;
    scene.add(topWall);

    const tunnel = new THREE.Mesh(new THREE.BoxGeometry(10, 8, 10), new THREE.MeshStandardMaterial({ color: 0x333333, side: THREE.DoubleSide }));
    tunnel.position.set(0, 4, -5.5);
    tunnel.receiveShadow = true;
    scene.add(tunnel);

    function addTree(x, z) {
        const trunk = new THREE.Mesh(new THREE.CylinderGeometry(0.2, 0.4, 2), new THREE.MeshStandardMaterial({color: 0x8B4513}));
        trunk.position.set(x, 1, z);
        
        const leaves = new THREE.Mesh(new THREE.ConeGeometry(2, 6, 8), new THREE.MeshStandardMaterial({color: 0x228b22}));
        leaves.position.set(x, 4, z);
        
        scene.add(trunk);
        scene.add(leaves);
    }
    for(let i=0; i<15; i++) addTree(-20 + Math.random()*40, 10 + Math.random()*40);

    // --- 4. PLAYER ---
    const playerGeo = new THREE.CapsuleGeometry(0.5, 1, 4, 8);
    const playerMat = new THREE.MeshStandardMaterial({ color: 0xffaa00 });
    const player = new THREE.Mesh(playerGeo, playerMat);
    player.position.set(0, 1, -8);
    player.castShadow = true;
    scene.add(player);

    // --- 5. DRAGON ---
    const dragonGroup = new THREE.Group();
    const dBody = new THREE.Mesh(new THREE.ConeGeometry(0.5, 3, 4), new THREE.MeshStandardMaterial({color: 0xff0000}));
    dBody.rotation.x = Math.PI / 2;
    const dWing = new THREE.Mesh(new THREE.BoxGeometry(4, 0.1, 1), new THREE.MeshStandardMaterial({color: 0xaa0000}));
    dragonGroup.add(dBody, dWing);
    dragonGroup.position.set(0, 15, 20);
    scene.add(dragonGroup);

    // --- 6. CONTROLS SYSTEM ---
    const keys = { w: false, a: false, s: false, d: false };
    
    // Keyboard Listeners
    window.addEventListener('keydown', (e) => keys[e.key.toLowerCase()] = true);
    window.addEventListener('keyup', (e) => keys[e.key.toLowerCase()] = false);

    // Touch Listeners (D-Pad)
    const dpadButtons = document.querySelectorAll('.d-pad-btn');
    
    dpadButtons.forEach(btn => {
        // Handle Touch Start
        btn.addEventListener('touchstart', (e) => {
            e.preventDefault(); // Stop scrolling/zooming on touch
            keys[btn.dataset.key] = true;
            btn.classList.add('active');
        }, { passive: false });

        // Handle Touch End
        btn.addEventListener('touchend', (e) => {
            e.preventDefault();
            keys[btn.dataset.key] = false;
            btn.classList.remove('active');
        }, { passive: false });

        // Mouse fallbacks for testing on PC with mouse clicks
        btn.addEventListener('mousedown', () => { keys[btn.dataset.key] = true; });
        btn.addEventListener('mouseup', () => { keys[btn.dataset.key] = false; });
        btn.addEventListener('mouseleave', () => { keys[btn.dataset.key] = false; });
    });

    // --- 7. ANIMATION LOOP ---
    let regionDiscovered = false;
    const playerSpeed = 0.15;

    function animate() {
        requestAnimationFrame(animate);

        // Movement Logic
        if (keys['w'] || keys['arrowup']) player.position.z += playerSpeed;
        if (keys['s'] || keys['arrowdown']) player.position.z -= playerSpeed;
        if (keys['a'] || keys['arrowleft']) player.position.x += playerSpeed;
        if (keys['d'] || keys['arrowright']) player.position.x -= playerSpeed;

        // Camera Follow
        const targetPos = player.position.clone();
        targetPos.add(new THREE.Vector3(0, 6, -10)); // Higher and further back for mobile visibility
        camera.position.lerp(targetPos, 0.1);
        camera.lookAt(player.position);

        // Dragon Animation
        const time = Date.now() * 0.001;
        dragonGroup.position.x = Math.sin(time) * 20;
        dragonGroup.position.z = 20 + Math.cos(time) * 10;
        dragonGroup.rotation.y = -time;

        // Trigger Event
        if (player.position.z > 2 && !regionDiscovered) {
            regionDiscovered = true;
            triggerUI();
        }

        renderer.render(scene, camera);
    }

    function triggerUI() {
        const ui = document.getElementById('ui-layer');
        const box = document.getElementById('region-box');
        
        ui.classList.add('visible');
        setTimeout(() => box.classList.add('pop-in'), 100);
        setTimeout(() => {
            ui.classList.remove('visible');
            box.classList.remove('pop-in');
        }, 4000);
    }

    // Resize Handler
    window.addEventListener('resize', () => {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
    });

    animate();
</script>
</body>
</html>
