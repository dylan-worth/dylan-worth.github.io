<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Engine Test</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="roblox-joystick.js"></script>
    <script src="roblox-cam.js"></script>
    <script src="roblox-engine.js"></script>

    <style>
        body { margin: 0; overflow: hidden; background: #000; touch-action: none; user-select: none; }
        #game-container { position: relative; width: 100%; height: 100vh; }
        
        /* JOYSTICK VISUALS */
        #joystick-zone {
            position: absolute; bottom: 50px; left: 50px;
            width: 120px; height: 120px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.5);
            border-radius: 50%; pointer-events: auto; z-index: 20;
        }
        #joystick-knob {
            position: absolute; top: 50%; left: 50%;
            width: 50px; height: 50px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 50%; transform: translate(-50%, -50%);
            pointer-events: none;
        }
        
        /* UI OVERLAY */
        #ui-layer {
            position: absolute; top: 20px; left: 20px; color: white;
            font-family: sans-serif; pointer-events: none; z-index: 20;
            text-shadow: 1px 1px 2px black;
        }
    </style>
</head>
<body>

    <div id="game-container">
        <div id="ui-layer">
            <h1>Engine Test V1</h1>
            <p>Left Stick: Move | Right Screen: Look</p>
        </div>

        <div id="joystick-zone"><div id="joystick-knob"></div></div>
    </div>

    <script>
        // 1. INIT ENGINE
        RobloxEngine.init('game-container', 'touch-layer');
        const scene = RobloxEngine.scene;
        const rCam = RobloxEngine.camControl;

        // 2. CREATE A SIMPLE TEST WORLD
        
        // Ground
        const ground = new THREE.Mesh(
            new THREE.PlaneGeometry(100, 100),
            new THREE.MeshStandardMaterial({ color: 0x2ecc71 }) // Green
        );
        ground.rotation.x = -Math.PI / 2;
        ground.receiveShadow = true;
        scene.add(ground);

        // Player (Red Box)
        const player = new THREE.Mesh(
            new THREE.BoxGeometry(2, 4, 2),
            new THREE.MeshStandardMaterial({ color: 0xe74c3c }) // Red
        );
        player.position.y = 2;
        player.castShadow = true;
        scene.add(player);

        // Obstacle (Blue Box)
        const box = new THREE.Mesh(
            new THREE.BoxGeometry(4, 4, 4),
            new THREE.MeshStandardMaterial({ color: 0x3498db }) // Blue
        );
        box.position.set(10, 2, 10);
        box.castShadow = true;
        scene.add(box);

        // Lights
        const dirLight = new THREE.DirectionalLight(0xffffff, 1);
        dirLight.position.set(50, 100, 50);
        dirLight.castShadow = true;
        scene.add(dirLight);

        // 3. DEFINE GAME LOOP
        RobloxEngine.onUpdate = function(dt) {
            // MOVEMENT LOGIC
            if (window.joystick && window.joystick.active) {
                const mx = window.joystick.x;
                const my = window.joystick.y;
                
                // Get Camera Angle
                const angle = rCam.theta;
                const fX = Math.sin(angle); 
                const fZ = Math.cos(angle);
                const rX = Math.sin(angle + Math.PI/2); 
                const rZ = Math.cos(angle + Math.PI/2);
                
                // Move Player relative to Camera
                const dx = (rX * mx) + (fX * my);
                const dz = (rZ * mx) + (fZ * my);
                
                player.position.x += dx * 0.3;
                player.position.z += dz * 0.3;
                
                // Face Direction
                player.rotation.y = Math.atan2(dx, dz);
            }

            // UPDATE CAMERA TO FOLLOW PLAYER
            rCam.update(player.position);
        };
    </script>
</body>
</html>
