<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Collision Test</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="roblox-joystick.js"></script>
    <script src="roblox-cam.js"></script>
    <script src="roblox-collision.js"></script> <script src="roblox-engine.js"></script>

    <style>
        body { margin: 0; overflow: hidden; background: #000; touch-action: none; user-select: none; }
        #game-container { position: relative; width: 100%; height: 100vh; }
        
        #ui-layer {
            position: absolute; top: 20px; left: 20px; color: white;
            font-family: sans-serif; pointer-events: none; z-index: 20;
            text-shadow: 1px 1px 2px black;
        }

        #joystick-zone { position: absolute; bottom: 50px; left: 50px; width: 120px; height: 120px; background: rgba(255, 255, 255, 0.1); border: 2px solid rgba(255, 255, 255, 0.5); border-radius: 50%; pointer-events: auto; z-index: 30; }
        #joystick-knob { position: absolute; top: 50%; left: 50%; width: 50px; height: 50px; background: rgba(255, 255, 255, 0.9); border-radius: 50%; transform: translate(-50%, -50%); pointer-events: none; }
    </style>
</head>
<body>

    <div id="game-container">
        <div id="ui-layer">
            <h1>Collision Test</h1>
            <p>Try to walk through the Blue Box!</p>
        </div>
        <div id="joystick-zone"><div id="joystick-knob"></div></div>
    </div>

    <script>
        // 1. INIT ENGINE
        RobloxEngine.init('game-container', 'touch-layer');
        const scene = RobloxEngine.scene;
        const rCam = RobloxEngine.camControl;

        // 2. CREATE WORLD
        const ground = new THREE.Mesh(new THREE.PlaneGeometry(100, 100), new THREE.MeshStandardMaterial({ color: 0x2ecc71 }));
        ground.rotation.x = -Math.PI / 2; scene.add(ground);

        const player = new THREE.Mesh(new THREE.BoxGeometry(2, 4, 2), new THREE.MeshStandardMaterial({ color: 0xe74c3c }));
        player.position.y = 2; player.castShadow = true; scene.add(player);

        // --- ADDING A SOLID OBJECT ---
        const box = new THREE.Mesh(new THREE.BoxGeometry(6, 6, 6), new THREE.MeshStandardMaterial({ color: 0x3498db }));
        box.position.set(10, 3, 10);
        box.castShadow = true;
        scene.add(box);
        
        // *IMPORTANT* Register it with the collision system
        CollisionSystem.add(box);

        // Add some lights
        const dirLight = new THREE.DirectionalLight(0xffffff, 1);
        dirLight.position.set(50, 100, 50); dirLight.castShadow = true; scene.add(dirLight);
        scene.add(new THREE.AmbientLight(0x404040));

        // 3. GAME LOOP
        RobloxEngine.onUpdate = function(dt) {
            // Movement
            if (window.joystick && window.joystick.active) {
                const mx = window.joystick.x; const my = window.joystick.y;
                const angle = rCam.theta;
                const fX = Math.sin(angle); const fZ = Math.cos(angle);
                const rX = Math.sin(angle + Math.PI/2); const rZ = Math.cos(angle + Math.PI/2);
                
                // Calculate Desired Move Amount
                const speed = 0.3;
                const dx = ((rX * mx) + (fX * my)) * speed;
                const dz = ((rZ * mx) + (fZ * my)) * speed;
                
                // *IMPORTANT* Move using the safe function
                CollisionSystem.moveSafely(player, dx, dz);
                
                // Rotate visual
                player.rotation.y = Math.atan2(dx, dz);
            }

            rCam.update(player.position);
        };
    </script>
</body>
</html>
