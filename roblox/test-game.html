<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Movement Test</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="roblox-joystick.js"></script>
    <script src="roblox-cam.js"></script>
    <script src="roblox-collision.js"></script>
    <script src="roblox-engine.js"></script>
    <script src="roblox-character.js"></script>

    <style>
        body { margin: 0; overflow: hidden; background: #000; touch-action: none; user-select: none; }
        #game-container { position: relative; width: 100%; height: 100vh; }
        #ui-layer { position: absolute; top: 20px; left: 20px; color: white; pointer-events: none; z-index: 20; font-family: sans-serif; }
        
        #jump-btn {
            position: absolute; bottom: 60px; right: 40px;
            width: 80px; height: 80px; background: rgba(0, 255, 0, 0.3);
            border: 2px solid #0f0; border-radius: 50%;
            pointer-events: auto; z-index: 20;
            display: flex; justify-content: center; align-items: center; color: white; font-weight: bold;
        }
        #fly-btn {
            position: absolute; bottom: 160px; right: 40px;
            width: 50px; height: 50px; background: rgba(0, 200, 255, 0.3);
            border: 2px solid cyan; border-radius: 50%;
            pointer-events: auto; z-index: 20; font-size: 10px; color: white;
            display: flex; justify-content: center; align-items: center;
        }
        #joystick-zone { position: absolute; bottom: 50px; left: 50px; width: 120px; height: 120px; background: rgba(255, 255, 255, 0.1); border-radius: 50%; pointer-events: auto; z-index: 20; }
        #joystick-knob { position: absolute; top: 50%; left: 50%; width: 50px; height: 50px; background: rgba(255, 255, 255, 0.9); border-radius: 50%; transform: translate(-50%, -50%); pointer-events: none; }
    </style>
</head>
<body>

    <div id="game-container">
        <div id="touch-layer" style="position:absolute; top:0; left:0; width:100%; height:100%; z-index:10;"></div>
        
        <div id="ui-layer">
            <h1>Movement Test</h1>
            <p>Double Jump: ON | Fly: Toggle</p>
        </div>

        <div id="jump-btn">JUMP</div>
        <div id="fly-btn">FLY</div>
        <div id="joystick-zone"><div id="joystick-knob"></div></div>
    </div>

    <script>
        // 1. INIT ENGINE
        RobloxEngine.init('game-container', 'touch-layer');
        const scene = RobloxEngine.scene;
        const rCam = RobloxEngine.camControl;

        // 2. WORLD
        const ground = new THREE.Mesh(new THREE.PlaneGeometry(100, 100), new THREE.MeshStandardMaterial({ color: 0x2ecc71 }));
        ground.rotation.x = -Math.PI / 2; scene.add(ground);
        const dirLight = new THREE.DirectionalLight(0xffffff, 1); dirLight.position.set(50, 100, 50); scene.add(dirLight);

        // Add Obstacle
        const wall = new THREE.Mesh(new THREE.BoxGeometry(10, 10, 2), new THREE.MeshStandardMaterial({color: 'blue'}));
        wall.position.set(0, 5, 10); scene.add(wall);
        CollisionSystem.add(wall); // Make it solid

        // 3. CREATE CHARACTER (Using the new Class)
        const player = new RobloxCharacter(scene, {x: 0, y: 5, z: 0}, 0xe74c3c);
        
        // --- SOFT LOCKS (Here is where we customize!) ---
        player.abilities.canDoubleJump = true; // ENABLED for this game
        player.abilities.canFly = false;       // Default off, toggleable

        // 4. BIND BUTTONS
        document.getElementById('jump-btn').addEventListener('touchstart', (e) => {
            e.preventDefault(); // Stop zoom/scroll
            player.jump(); 
        });
        
        document.getElementById('fly-btn').addEventListener('touchstart', (e) => {
            e.preventDefault();
            player.toggleFly();
        });

        // 5. GAME LOOP
        RobloxEngine.onUpdate = function(dt) {
            // Pass inputs to the Player Brain
            // The player handles its own physics and collision now!
            player.update(dt, window.joystick, rCam.theta, CollisionSystem);

            // Camera follow
            rCam.update(player.mesh.position);
        };
    </script>
</body>
</html>
