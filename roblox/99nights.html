<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>99 Nights (3D)</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        body { overflow: hidden; }
        #game-container { position: relative; width: 100%; height: 80vh; background: #000; }
        canvas { width: 100%; height: 100%; display: block; }
        .hud { position: absolute; top: 10px; left: 0; width: 100%; text-align: center; color: #ff5e57; font-weight: bold; pointer-events: none; }
        #mobile-controls { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 10; }
    </style>
</head>
<body>
    <nav>
        <h1>BLOX</h1>
        <div class="nav-links"><a href="roblox.html">Exit</a></div>
    </nav>
    
    <div id="game-container">
        <div class="hud">Nights: <span id="night-count">0</span> | Battery: <span id="battery">100</span>%</div>
        <div id="mobile-controls">
            <div></div>
            <div class="d-btn" ontouchstart="press('w')" ontouchend="release('w')">▲</div>
            <div></div>
            <div class="d-btn" ontouchstart="press('a')" ontouchend="release('a')">◀</div>
            <div class="d-btn" ontouchstart="press('s')" ontouchend="release('s')">▼</div>
            <div class="d-btn" ontouchstart="press('d')" ontouchend="release('d')">▶</div>
        </div>
    </div>
    
    <script>
        // --- 3D SETUP ---
        const container = document.getElementById('game-container');
        const scene = new THREE.Scene();
        scene.fog = new THREE.FogExp2(0x111111, 0.02); // Scary fog
        scene.background = new THREE.Color(0x111111);

        const camera = new THREE.PerspectiveCamera(75, container.clientWidth / container.clientHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer();
        renderer.setSize(container.clientWidth, container.clientHeight);
        container.appendChild(renderer.domElement);

        // Ground
        const planeGeo = new THREE.PlaneGeometry(200, 200);
        const planeMat = new THREE.MeshStandardMaterial({ color: 0x1e272e });
        const plane = new THREE.Mesh(planeGeo, planeMat);
        plane.rotation.x = -Math.PI / 2;
        scene.add(plane);

        // Trees (Random Cylinders)
        const treeGeo = new THREE.CylinderGeometry(0.5, 1, 10, 8);
        const treeMat = new THREE.MeshStandardMaterial({ color: 0x000000 });
        
        for(let i=0; i<50; i++) {
            const tree = new THREE.Mesh(treeGeo, treeMat);
            tree.position.x = (Math.random() - 0.5) * 100;
            tree.position.z = (Math.random() - 0.5) * 100;
            tree.position.y = 5;
            scene.add(tree);
        }

        // Player (Invisible representation for camera)
        const player = { x: 0, z: 10, speed: 0.2 };
        camera.position.set(0, 2, 10);

        // Flashlight (Spotlight attached to camera)
        const light = new THREE.SpotLight(0xffffff, 1);
        light.position.set(0, 2, 10);
        light.angle = 0.5;
        light.penumbra = 0.5;
        light.decay = 2;
        light.distance = 50;
        light.castShadow = true;
        scene.add(light);
        scene.add(light.target);

        // Ambient light (very dim)
        const ambient = new THREE.AmbientLight(0x404040, 0.1); 
        scene.add(ambient);

        // --- GAME LOGIC ---
        let keys = {};
        let battery = 100;
        
        window.addEventListener('keydown', e => keys[e.key] = true);
        window.addEventListener('keyup', e => keys[e.key] = false);
        window.press = (k) => keys[k] = true;
        window.release = (k) => keys[k] = false;

        function animate() {
            requestAnimationFrame(animate);

            // Movement
            if(keys['w']) camera.translateZ(-player.speed);
            if(keys['s']) camera.translateZ(player.speed);
            if(keys['a']) camera.translateX(-player.speed);
            if(keys['d']) camera.translateX(player.speed);

            // Flashlight follows camera
            light.position.copy(camera.position);
            
            // Flashlight target logic (aim slightly ahead)
            const dir = new THREE.Vector3();
            camera.getWorldDirection(dir);
            light.target.position.copy(camera.position).add(dir);

            // Battery drain
            if(battery > 0) {
                battery -= 0.05;
                document.getElementById('battery').innerText = Math.floor(battery);
            } else {
                light.intensity = 0; // Lights out
            }

            renderer.render(scene, camera);
        }

        // Resize handler
        window.addEventListener('resize', () => {
            camera.aspect = container.clientWidth / container.clientHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(container.clientWidth, container.clientHeight);
        });

        animate();
    </script>
</body>
</html>
