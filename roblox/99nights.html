<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>99 Nights - Survival</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    
    <script src="99nightsui.js"></script>

    <style>
        body { margin: 0; overflow: hidden; background: #000; user-select: none; font-family: 'Segoe UI', sans-serif; touch-action: none; }
        #game-container { position: relative; width: 100%; height: 100vh; }
        canvas { display: block; width: 100%; height: 100%; outline: none; }
        
        /* UI LAYOUT */
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10; }
        #touch-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 5; }

        /* HUD */
        .hud-top { position: absolute; top: 10px; width: 100%; text-align: center; color: white; text-shadow: 1px 1px 2px black; pointer-events: none; }
        .xp-bar-container { width: 200px; height: 10px; background: #333; margin: 5px auto; border: 1px solid #555; border-radius: 5px; overflow: hidden; }
        #xp-bar-fill { height: 100%; width: 0%; background: #00b06f; transition: width 0.2s; }

        /* MINIMAP */
        #minimap-container { position: absolute; top: 20px; right: 20px; width: 100px; height: 100px; background: rgba(0,0,0,0.5); border: 2px solid #777; border-radius: 50%; overflow: hidden; display: none; }
        #minimap-canvas { width: 100%; height: 100%; }

        /* INVENTORY */
        #inventory-bar { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); display: flex; gap: 5px; background: rgba(0,0,0,0.6); padding: 10px; border-radius: 10px; pointer-events: auto; }
        .inv-slot { width: 50px; height: 50px; background: rgba(255,255,255,0.1); border: 2px solid #555; border-radius: 5px; position: relative; display: flex; justify-content: center; align-items: center; color: white; font-size: 20px; }
        .item-icon { width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; cursor: grab; }
        .item-count { position: absolute; bottom: 2px; right: 2px; font-size: 10px; font-weight: bold; background: rgba(0,0,0,0.5); padding: 1px 3px; border-radius: 3px; }

        /* BUTTONS */
        #jump-btn { position: absolute; bottom: 120px; right: 20px; width: 60px; height: 60px; background: rgba(255,255,255,0.15); border: 2px solid rgba(255,255,255,0.5); border-radius: 50%; color: white; font-weight: bold; font-size: 12px; display: flex; pointer-events: auto; justify-content: center; align-items: center; cursor: pointer; backdrop-filter: blur(2px); }
        #jump-btn:active { background: rgba(255,255,255,0.4); transform: scale(0.95); }

        #action-btn { position: absolute; bottom: 190px; right: 30px; width: 80px; height: 80px; background: rgba(0, 176, 111, 0.3); border: 3px solid #00b06f; border-radius: 50%; color: white; font-weight: bold; font-size: 30px; display: none; pointer-events: auto; justify-content: center; align-items: center; cursor: pointer; box-shadow: 0 0 15px rgba(0,0,0,0.5); }
        #action-btn:active { background: #00b06f; transform: scale(0.95); }

        /* TOAST */
        #toast { position: absolute; top: 100px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.8); color: white; padding: 10px 20px; border-radius: 20px; opacity: 0; transition: opacity 0.5s; pointer-events: none; font-size: 14px; text-align: center; }

        /* JOYSTICK */
        #joystick-zone { position: absolute; bottom: 100px; left: 30px; width: 100px; height: 100px; background: rgba(255, 255, 255, 0.1); border: 2px solid rgba(255, 255, 255, 0.4); border-radius: 50%; pointer-events: auto; z-index: 15; }
        #joystick-knob { position: absolute; top: 50%; left: 50%; width: 40px; height: 40px; background: rgba(255, 255, 255, 0.8); border-radius: 50%; transform: translate(-50%, -50%); pointer-events: none; }

        /* CRAFT MENU */
        #craft-menu { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(20, 20, 20, 0.95); border: 2px solid #555; padding: 20px; color: white; display: none; pointer-events: auto; text-align: center; border-radius: 10px; width: 250px; z-index: 20; }
        .craft-btn { background: #333; color: white; border: 1px solid #555; padding: 10px; width: 100%; margin-bottom: 5px; cursor: pointer; }
        .exit-btn { position: absolute; top: 10px; left: 10px; pointer-events: auto; background: rgba(255,255,255,0.2); color: white; padding: 5px 10px; border-radius: 5px; text-decoration: none; }
    </style>
</head>
<body>

    <div id="game-container">
        <div id="touch-layer"></div>

        <div id="ui-layer">
            <a href="roblox.html" class="exit-btn">‚¨Ö Exit</a>
            
            <div class="hud-top">
                <div style="font-size: 18px; font-weight: bold;">Campfire Lv <span id="camp-lvl">1</span></div>
                <div class="xp-bar-container"><div id="xp-bar-fill"></div></div>
                <div><span id="time-display">Day 1</span></div>
            </div>

            <div id="minimap-container"><canvas id="minimap-canvas" width="100" height="100"></canvas></div>
            <div id="toast">Message</div>

            <div id="jump-btn" ontouchstart="jumpAction(event)">JUMP</div>
            <div id="action-btn" ontouchstart="interactAction(event)">üëã</div>

            <div id="inventory-bar"></div>

            <div id="craft-menu">
                <h3>Workbench</h3>
                <button class="craft-btn" onclick="craftItem('map')">üó∫Ô∏è Craft Map (5 Wood)</button>
                <button class="craft-btn" onclick="craftItem('bed')">üõèÔ∏è Craft Bed (10 Wood)</button>
                <button class="craft-btn" onclick="craftItem('upgrade_bench')">üõ†Ô∏è Upgrade Bench (20 Wood)</button>
                <button class="craft-btn" onclick="UI.toggleCraftMenu(false)">Close</button>
            </div>
        </div>
        
        <div id="joystick-zone"><div id="joystick-knob"></div></div>
    </div>

    <script>
        // --- 3D SCENE SETUP ---
        const container = document.getElementById('game-container');
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x87CEEB); 
        scene.fog = new THREE.Fog(0x87CEEB, 5, 25); // Initial Fog

        const camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.shadowMap.enabled = true;
        renderer.shadowMap.type = THREE.PCFSoftShadowMap;
        container.insertBefore(renderer.domElement, document.getElementById('touch-layer'));

        // Camera Vars
        let camRadius = 12; 
        let camTheta = Math.PI; 
        let camPhi = Math.PI / 3;

        // Lighting
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
        scene.add(ambientLight);
        const sunLight = new THREE.DirectionalLight(0xffaa33, 1.2);
        sunLight.position.set(50, 50, 0);
        sunLight.castShadow = true;
        scene.add(sunLight);

        // Ground
        const ground = new THREE.Mesh(new THREE.PlaneGeometry(300, 300), new THREE.MeshStandardMaterial({ color: 0x2f3628 }));
        ground.rotation.x = -Math.PI / 2;
        ground.receiveShadow = true;
        scene.add(ground);

        // Player
        const playerGroup = new THREE.Group();
        const body = new THREE.Mesh(new THREE.BoxGeometry(1, 2, 0.5), new THREE.MeshStandardMaterial({color: 0xd35400})); body.position.y = 1;
        const head = new THREE.Mesh(new THREE.BoxGeometry(0.6, 0.6, 0.6), new THREE.MeshStandardMaterial({color: 0xffe0bd})); head.position.y = 2.3;
        const sack = new THREE.Mesh(new THREE.BoxGeometry(0.8, 0.8, 0.5), new THREE.MeshStandardMaterial({color: 0x8d6e63})); sack.position.set(0, 1.5, -0.4);
        
        // Axe Visuals
        const axePivot = new THREE.Group(); axePivot.position.set(0.6, 1.8, 0);
        const axeGroup = new THREE.Group();
        const handle = new THREE.Mesh(new THREE.CylinderGeometry(0.04, 0.04, 1.2), new THREE.MeshStandardMaterial({color: 0x5d4037})); handle.position.y = 0.6;
        const blade = new THREE.Mesh(new THREE.BoxGeometry(0.4, 0.3, 0.05), new THREE.MeshStandardMaterial({color: 0x95a5a6})); blade.position.set(0.15, 1.1, 0);
        axeGroup.add(handle); axeGroup.add(blade); axeGroup.rotation.x = Math.PI/2; axeGroup.rotation.z = -0.2; axePivot.add(axeGroup);

        playerGroup.add(body); playerGroup.add(head); playerGroup.add(sack); playerGroup.add(axePivot);
        playerGroup.castShadow = true;
        scene.add(playerGroup);

        // --- WORLD GENERATION ---
        const fireGroup = new THREE.Group();
        const fireLight = new THREE.PointLight(0xff4500, 2, 15); fireLight.position.y = 1; fireGroup.add(fireLight);
        const log1 = new THREE.Mesh(new THREE.CylinderGeometry(0.1, 0.1, 1.5), new THREE.MeshStandardMaterial({color: 0x3e2723})); log1.rotation.z=Math.PI/2; log1.position.y=0.1; fireGroup.add(log1);
        const log2 = new THREE.Mesh(new THREE.CylinderGeometry(0.1, 0.1, 1.5), new THREE.MeshStandardMaterial({color: 0x3e2723})); log2.rotation.x=Math.PI/2; log2.position.y=0.1; fireGroup.add(log2);
        for(let i=0; i<8; i++){ const p=new THREE.Mesh(new THREE.BoxGeometry(0.15,0.15,0.15), new THREE.MeshBasicMaterial({color: 0xffaa00})); p.position.set((Math.random()-0.5),Math.random()*1.5,(Math.random()-0.5)); fireGroup.add(p); }
        scene.add(fireGroup);

        const bench = new THREE.Mesh(new THREE.BoxGeometry(2,1,1), new THREE.MeshStandardMaterial({color:0x795548})); bench.position.set(6,0.5,6); scene.add(bench);

        // Trees
        const trees = [];
        function spawnTree(x,z) {
            const t = new THREE.Group();
            const trunk = new THREE.Mesh(new THREE.CylinderGeometry(0.3,0.4,2), new THREE.MeshStandardMaterial({color:0x4e342e})); trunk.position.y=1;
            const leaves = new THREE.Mesh(new THREE.ConeGeometry(1.5,5,6), new THREE.MeshStandardMaterial({color:0x145a32})); leaves.position.y=3.5;
            t.add(trunk); t.add(leaves); t.position.set(x,0,z); t.userData={hp:3, type:'tree'};
            scene.add(t); trees.push(t);
        }
        for(let i=0; i<60; i++) { let tx=(Math.random()-0.5)*150; let tz=(Math.random()-0.5)*150; if(Math.abs(tx)>8 || Math.abs(tz)>8) spawnTree(tx,tz); }

        // Mobs
        const mobs = [];
        function spawnMob(type,x,z) {
            const mob = new THREE.Group();
            let c = type==='wolf'?0x7f8c8d:0xffffff; let s = type==='wolf'?1:0.5;
            const b = new THREE.Mesh(new THREE.BoxGeometry(s,s/2,s*1.5), new THREE.MeshStandardMaterial({color:c})); b.position.y=s/2;
            const h = new THREE.Mesh(new THREE.BoxGeometry(s/1.5,s/1.5,s/1.5), new THREE.MeshStandardMaterial({color:c})); h.position.set(0,s,s/1.5);
            mob.add(b); mob.add(h); mob.position.set(x,0,z); mob.userData={type:type, speed:type==='wolf'?0.08:0.03, tm:0};
            scene.add(mob); mobs.push(mob);
        }
        for(let i=0; i<15; i++) spawnMob(i<5?'wolf':'bunny', (Math.random()-0.5)*80, (Math.random()-0.5)*80);

        const droppedLogs = [];
        
        // --- TAP TO PICKUP (Raycast) ---
        const raycaster = new THREE.Raycaster();
        const mouse = new THREE.Vector2();
        window.gameCheckTap = function(clientX, clientY) {
            mouse.x = (clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(clientY / window.innerHeight) * 2 + 1;
            raycaster.setFromCamera(mouse, camera);
            const intersects = raycaster.intersectObjects(droppedLogs, true);
            if (intersects.length > 0) {
                const log = intersects[0].object;
                if (playerGroup.position.distanceTo(log.position) < 6) {
                    // Logic to pick up
                    if (Inventory.addWood(1)) {
                        scene.remove(log);
                        const idx = droppedLogs.indexOf(log);
                        if (idx > -1) droppedLogs.splice(idx, 1);
                        UI.showToast("+1 Wood");
                        UI.updateHUD(); // Refresh Sack UI
                    } else {
                        UI.showToast("Sack is Full!");
                    }
                } else UI.showToast("Too far!");
            }
        };

        // --- MAIN LOOP ---
        const clock = new THREE.Clock();
        function animate() {
            requestAnimationFrame(animate);
            let dt = clock.getDelta();

            // Sync with UI State
            scene.fog.far = gameState.fogDist; // Fog expansion
            
            // Environment (Time)
            gameState.time += dt / 180;
            if (gameState.time > 1) { gameState.time = 0; gameState.day++; }
            UI.updateHUD(); // Update time display

            const sunAngle = (gameState.time - 0.25) * Math.PI * 2;
            sunLight.position.x = Math.cos(sunAngle) * 50; sunLight.position.y = Math.sin(sunAngle) * 50;
            let intensity = Math.max(0, Math.sin(sunAngle));
            if(gameState.time > 0.75 || gameState.time < 0.25) intensity = 0;
            sunLight.intensity = intensity; ambientLight.intensity = 0.5 + (intensity * 0.4);
            scene.background.setHSL(0.6, 0.5, intensity * 0.5); scene.fog.color.copy(scene.background);
            fireLight.intensity = (1 - intensity) * (2 + gameState.campLevel);

            // Inputs
            const spd = 0.15;
            const fX = Math.sin(camTheta); const fZ = Math.cos(camTheta);
            const rX = Math.sin(camTheta + Math.PI/2); const rZ = Math.cos(camTheta + Math.PI/2);
            
            if (gameState.moveX !== 0 || gameState.moveY !== 0) {
                const wx = (rX * gameState.moveX) + (fX * gameState.moveY);
                const wz = (rZ * gameState.moveX) + (fZ * gameState.moveY);
                playerGroup.position.x += wx * spd; playerGroup.position.z += wz * spd;
                playerGroup.rotation.y = Math.atan2(wx, wz);
            }

            // Camera Look
            camTheta -= gameState.lookDeltaX * 0.005;
            camPhi -= gameState.lookDeltaY * 0.005;
            camPhi = Math.max(0.1, Math.min(Math.PI/2-0.1, camPhi));
            
            // Physics
            gameState.velocityY -= 0.015; playerGroup.position.y += gameState.velocityY;
            if (playerGroup.position.y <= 0) { playerGroup.position.y = 0; gameState.velocityY = 0; gameState.isGrounded = true; }

            // Camera Follow
            camera.position.x = playerGroup.position.x + camRadius * Math.sin(camTheta) * Math.sin(camPhi);
            camera.position.z = playerGroup.position.z + camRadius * Math.cos(camTheta) * Math.sin(camPhi);
            camera.position.y = playerGroup.position.y + camRadius * Math.cos(camPhi);
            camera.lookAt(playerGroup.position.x, playerGroup.position.y + 1, playerGroup.position.z);

            // Mobs
            mobs.forEach(mob => {
                mob.userData.tm += dt;
                if(mob.userData.type === 'bunny') {
                    if(mob.userData.tm > 2) { mob.rotation.y = Math.random()*Math.PI*2; mob.userData.tm=0; }
                    mob.position.z += Math.cos(mob.rotation.y)*0.03; mob.position.x += Math.sin(mob.rotation.y)*0.03;
                } else { // Wolf
                    const d = playerGroup.position.distanceTo(mob.position);
                    if(d < 15 && d > 1) {
                        mob.lookAt(playerGroup.position);
                        mob.position.z += Math.cos(mob.rotation.y)*0.08; mob.position.x += Math.sin(mob.rotation.y)*0.08;
                    } else if(mob.userData.tm > 3) { mob.rotation.y=Math.random()*Math.PI*2; mob.userData.tm=0; }
                }
            });

            // Swing Animation
            if(gameState.isSwinging) {
                axePivot.rotation.x -= 0.2;
                if(axePivot.rotation.x < -2) { axePivot.rotation.x = 0; gameState.isSwinging = false; }
                
                // Hitting Logic
                if (axePivot.rotation.x < -1 && gameState.nearbyObject && gameState.nearbyObject.type === 'tree') {
                    const t = gameState.nearbyObject.obj;
                    t.userData.hp--; t.rotation.z = 0.1; setTimeout(()=>t.rotation.z=0, 50);
                    if(t.userData.hp <= 0) {
                        // Spawn Log
                        const log = new THREE.Mesh(new THREE.CylinderGeometry(0.15, 0.15, 1), new THREE.MeshStandardMaterial({color: 0x8d6e63}));
                        log.rotation.z = Math.PI/2; log.rotation.y = Math.random()*Math.PI;
                        log.position.set(t.position.x, 0.2, t.position.z); log.castShadow=true;
                        scene.add(log); droppedLogs.push(log);
                        
                        scene.remove(t); trees.splice(trees.indexOf(t),1); gameState.nearbyObject=null;
                    }
                    gameState.nearbyObject = null; // Prevent double hit
                }
            }

            // Sack Visual
            const sScale = 1 + (gameState.wood * 0.05);
            sack.scale.set(sScale, sScale, sScale);

            // Interactions Check
            const pPos = playerGroup.position;
            gameState.nearbyObject = null;
            let showAction = false; let actionIcon = '';
            
            if (pPos.distanceTo(fireGroup.position) < 3.5) { gameState.nearbyObject = {type:'fire'}; showAction=true; actionIcon='üî•'; }
            else if (pPos.distanceTo(bench.position) < 3) { gameState.nearbyObject = {type:'bench'}; showAction=true; actionIcon='üõ†Ô∏è'; }
            else {
                for(let t of trees) {
                    if (pPos.distanceTo(t.position) < 2.5) { gameState.nearbyObject = {type:'tree', obj:t}; showAction=true; actionIcon='ü™ì'; break; }
                }
            }
            UI.toggleActionBtn(showAction, actionIcon);

            // Map
            UI.drawMinimap(playerGroup.position, [
                {pos: fireGroup.position, color: 'orange'},
                {pos: bench.position, color: 'brown'}
            ]);

            renderer.render(scene, camera);
        }
        animate();
        window.addEventListener('resize', () => { camera.aspect = window.innerWidth/window.innerHeight; camera.updateProjectionMatrix(); renderer.setSize(window.innerWidth, window.innerHeight); });
    </script>
</body>
</html>
