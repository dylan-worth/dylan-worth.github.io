<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>99 Nights (3D)</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="roblox-joystick.js"></script> <style>
        body { overflow: hidden; }
        #game-container { position: relative; width: 100%; height: 100vh; background: #000; }
        canvas { width: 100%; height: 100%; display: block; }
        .hud { position: absolute; top: 10px; left: 0; width: 100%; text-align: center; color: #ff5e57; font-weight: bold; pointer-events: none; z-index: 10; }
        /* No visual D-pad needed anymore */
    </style>
</head>
<body>
    <nav style="position:absolute; top:0; z-index:20; background:transparent; border:none;">
        <div class="nav-links"><a href="roblox.html" style="background:rgba(0,0,0,0.5); padding:5px 10px; border-radius:5px;">Exit</a></div>
    </nav>
    
    <div id="game-container">
        <div class="hud">Nights: <span id="night-count">0</span> | Battery: <span id="battery">100</span>%</div>
    </div>
    
    <script>
        const container = document.getElementById('game-container');
        const scene = new THREE.Scene();
        scene.fog = new THREE.FogExp2(0x111111, 0.03);
        scene.background = new THREE.Color(0x111111);

        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer();
        renderer.setSize(window.innerWidth, window.innerHeight);
        container.appendChild(renderer.domElement);

        // Ground
        const plane = new THREE.Mesh(new THREE.PlaneGeometry(200, 200), new THREE.MeshStandardMaterial({ color: 0x1e272e }));
        plane.rotation.x = -Math.PI / 2;
        scene.add(plane);

        // Trees
        const treeGeo = new THREE.CylinderGeometry(0.5, 1, 10, 8);
        const treeMat = new THREE.MeshStandardMaterial({ color: 0x0a0a0a });
        for(let i=0; i<60; i++) {
            const tree = new THREE.Mesh(treeGeo, treeMat);
            tree.position.set((Math.random()-0.5)*100, 5, (Math.random()-0.5)*100);
            scene.add(tree);
        }

        camera.position.set(0, 2, 10);
        const light = new THREE.SpotLight(0xffffff, 1.2, 60, 0.6, 0.5, 1);
        scene.add(light);
        scene.add(light.target);

        let keys = {};
        let battery = 100;
        let speed = 0.15;

        window.addEventListener('keydown', e => keys[e.key] = true);
        window.addEventListener('keyup', e => keys[e.key] = false);

        function animate() {
            requestAnimationFrame(animate);

            // KEYBOARD
            if(keys['w']) camera.translateZ(-speed);
            if(keys['s']) camera.translateZ(speed);
            if(keys['a']) camera.translateX(-speed);
            if(keys['d']) camera.translateX(speed);

            // JOYSTICK (Connected here)
            // joystick.getY() returns -1 (up) to 1 (down), so we flip logic or sign as needed
            if (window.joystick && window.joystick.active) {
                camera.translateZ(window.joystick.getY() * speed); 
                camera.translateX(window.joystick.getX() * speed);
            }

            // Flashlight Logic
            light.position.copy(camera.position);
            const dir = new THREE.Vector3();
            camera.getWorldDirection(dir);
            light.target.position.copy(camera.position).add(dir);

            if(battery > 0) {
                battery -= 0.03;
                document.getElementById('battery').innerText = Math.floor(battery);
            } else {
                light.intensity = 0;
            }

            renderer.render(scene, camera);
        }
        animate();
    </script>
</body>
</html>
