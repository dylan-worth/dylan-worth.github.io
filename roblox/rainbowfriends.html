<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Rainbow Friends 3D</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="roblox-joystick.js"></script> <style>
        body { overflow: hidden; background: #000; }
        #game-container { position: relative; width: 100%; height: 100vh; }
        .hud { position: absolute; top: 20px; width: 100%; text-align: center; color: white; font-size: 24px; font-weight: bold; pointer-events: none; }
    </style>
</head>
<body>
    <nav style="position:absolute; top:0; z-index:20; background:transparent;">
        <div class="nav-links"><a href="roblox.html" style="background:rgba(255,255,255,0.1); padding:5px 10px; color:white; text-decoration:none;">Exit</a></div>
    </nav>
    
    <div id="game-container">
        <div class="hud">Cubes: <span id="score">0</span>/5</div>
    </div>

    <script>
        const container = document.getElementById('game-container');
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x2d3436);

        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(0, 8, 12);
        camera.lookAt(0, 0, 0);

        const renderer = new THREE.WebGLRenderer();
        renderer.setSize(window.innerWidth, window.innerHeight);
        container.appendChild(renderer.domElement);

        const light = new THREE.PointLight(0xffffff, 1, 100);
        light.position.set(0, 20, 0);
        scene.add(light);
        scene.add(new THREE.AmbientLight(0x404040));

        const floor = new THREE.Mesh(new THREE.PlaneGeometry(100, 100), new THREE.MeshStandardMaterial({ color: 0x636e72 }));
        floor.rotation.x = -Math.PI / 2;
        scene.add(floor);

        // Player (Invisible wrapper for logic)
        const player = { x: 0, z: 0, speed: 0.3 };
        const playerMesh = new THREE.Mesh(new THREE.BoxGeometry(1, 2, 1), new THREE.MeshStandardMaterial({ color: 0x00ff00 }));
        playerMesh.position.y = 1;
        scene.add(playerMesh);

        // Blue Monster
        const blue = new THREE.Mesh(new THREE.CylinderGeometry(1.5, 1.5, 5, 12), new THREE.MeshStandardMaterial({ color: 0x0984e3 }));
        blue.position.set(20, 2.5, -20);
        scene.add(blue);

        // Boxes
        let boxes = [];
        for(let i=0; i<5; i++) {
            const b = new THREE.Mesh(new THREE.BoxGeometry(1.5, 1.5, 1.5), new THREE.MeshStandardMaterial({color: 0xff9f43}));
            b.position.set((Math.random()-0.5)*60, 0.75, (Math.random()-0.5)*60);
            scene.add(b);
            boxes.push(b);
        }

        let keys = {};
        let collected = 0;
        window.addEventListener('keydown', e => keys[e.key] = true);
        window.addEventListener('keyup', e => keys[e.key] = false);

        function animate() {
            requestAnimationFrame(animate);

            // INPUT
            let dx = 0;
            let dz = 0;
            if(keys['w']) dz = -1;
            if(keys['s']) dz = 1;
            if(keys['a']) dx = -1;
            if(keys['d']) dx = 1;

            if (window.joystick && window.joystick.active) {
                dx = window.joystick.getX();
                dz = window.joystick.getY();
            }

            player.x += dx * player.speed;
            player.z += dz * player.speed;
            playerMesh.position.set(player.x, 1, player.z);

            // Camera Follow
            camera.position.x = player.x;
            camera.position.z = player.z + 10;

            // Monster Logic
            const dist = Math.sqrt((player.x - blue.position.x)**2 + (player.z - blue.position.z)**2);
            if(dist > 1.5) {
                blue.position.x += (player.x - blue.position.x) * 0.015;
                blue.position.z += (player.z - blue.position.z) * 0.015;
            } else {
                alert("CAUGHT!");
                location.reload();
            }

            // Box Logic
            for(let i=boxes.length-1; i>=0; i--) {
                const bDist = Math.sqrt((player.x - boxes[i].position.x)**2 + (player.z - boxes[i].position.z)**2);
                if(bDist < 2) {
                    scene.remove(boxes[i]);
                    boxes.splice(i, 1);
                    collected++;
                    document.getElementById('score').innerText = collected;
                    if(collected === 5) { alert("YOU WON!"); location.href="roblox.html"; }
                }
            }

            renderer.render(scene, camera);
        }
        animate();
    </script>
</body>
</html>
