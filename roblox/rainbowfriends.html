<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Rainbow Friends</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="roblox-joystick.js"></script>
    <script src="roblox-cam.js"></script>
    <script src="Rainbowfriends-level.js"></script> <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: 'Arial', sans-serif; user-select: none; }
        #game-container { position: relative; width: 100%; height: 100vh; }
        
        /* LAYERS */
        #touch-layer { position: absolute; top:0; left:0; width:100%; height:100%; z-index: 10; }
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 20; }

        /* HUD */
        .hud { position: absolute; top: 20px; width: 100%; text-align: center; color: white; font-size: 24px; font-weight: bold; text-shadow: 0 0 10px #000; }
        .exit-btn { position: absolute; top: 10px; left: 10px; pointer-events: auto; background: rgba(255,255,255,0.2); color: white; padding: 8px 12px; border-radius: 8px; text-decoration: none; font-weight: bold; }

        /* BOX BUTTON */
        #box-btn {
            position: absolute; bottom: 100px; right: 30px;
            width: 80px; height: 80px;
            background: #d35400; border: 3px solid #e67e22;
            border-radius: 15px; color: white; font-size: 40px;
            display: flex; justify-content: center; align-items: center;
            pointer-events: auto; cursor: pointer; box-shadow: 0 5px 0 #a04000;
        }
        #box-btn:active { transform: translateY(5px); box-shadow: none; }

        /* JOYSTICK */
        #joystick-zone { position: absolute; bottom: 80px; left: 40px; width: 100px; height: 100px; background: rgba(255, 255, 255, 0.1); border: 2px solid rgba(255, 255, 255, 0.3); border-radius: 50%; pointer-events: auto; z-index: 30; }
        #joystick-knob { position: absolute; top: 50%; left: 50%; width: 40px; height: 40px; background: rgba(255, 255, 255, 0.8); border-radius: 50%; transform: translate(-50%, -50%); pointer-events: none; }

        /* CUTSCENE UI */
        #cutscene-overlay {
            position: absolute; bottom: 50px; left: 50%; transform: translateX(-50%);
            width: 80%; background: rgba(0,0,0,0.8); color: white;
            padding: 20px; border-radius: 10px; text-align: center;
            font-size: 18px; border: 2px solid #c0392b;
            display: none; z-index: 50;
        }

        /* TRY AGAIN SCREEN */
        #game-over {
            display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 60;
            flex-direction: column; justify-content: center; align-items: center;
            color: white; pointer-events: auto;
        }
        .fail-text { font-size: 40px; font-weight: bold; color: #3498db; margin-bottom: 20px; }
        .retry-btn { padding: 15px 40px; font-size: 20px; background: white; border: none; border-radius: 30px; cursor: pointer; font-weight: bold; }
    </style>
</head>
<body>

    <div id="game-container">
        <div id="touch-layer"></div>
        
        <div id="ui-layer">
            <a href="roblox.html" class="exit-btn">Exit</a>
            <div class="hud">Boxes: <span id="score">0</span>/5</div>
            
            <div id="box-btn" ontouchstart="toggleBox()">ðŸ“¦</div>
        </div>

        <div id="joystick-zone"><div id="joystick-knob"></div></div>

        <div id="cutscene-overlay">
            <div id="cutscene-text">...</div>
        </div>

        <div id="game-over">
            <div class="fail-text">CAUGHT!</div>
            <button class="retry-btn" onclick="location.reload()">Try Again</button>
        </div>
    </div>

    <script>
        // --- SETUP ---
        const container = document.getElementById('game-container');
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x111);
        scene.fog = new THREE.Fog(0x111, 10, 60);

        const camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.shadowMap.enabled = true;
        container.insertBefore(renderer.domElement, document.getElementById('touch-layer'));

        // Initialize Camera Controller
        const rCam = new RobloxCamera(camera, document.getElementById('touch-layer'));

        // Lighting
        const spot = new THREE.SpotLight(0xffffff, 1);
        spot.position.set(50, 100, 50); spot.castShadow = true; scene.add(spot);
        scene.add(new THREE.AmbientLight(0x404040));

        // --- LOAD LEVEL ASSETS (From Rainbowfriends-level.js) ---
        Level.initMap(scene); // Generates Maze
        const boxes = Level.spawnCollectibles(scene); // Generates Quest Items

        // Player
        const player = createCharacterModel(); // Realistic Player
        player.position.set(20, 0, 20); // Spawn Point
        player.userData = { isHiding: false, speed: 0.3 };
        scene.add(player);

        // Blue Monster
        const blue = createBlueMonster(); // Realistic Blue
        blue.position.set(80, 0, 80);
        scene.add(blue);

        // Red (Cutscene Only)
        const red = createRedCharacter();
        scene.add(red);

        // --- GAME STATE ---
        let gameActive = false;
        let collected = 0;

        // Start Cutscene
        Cutscene.start(camera, red, document.getElementById('cutscene-overlay'));
        
        // Wait for cutscene to end before giving control
        setTimeout(() => {
            gameActive = true;
            scene.remove(red); // Remove Red
            rCam.tRadius = 20; // Zoom out slightly
        }, 7000);

        // --- BOX LOGIC ---
        window.toggleBox = function() {
            if(!gameActive) return;
            player.userData.isHiding = !player.userData.isHiding;
            
            // Toggle Visibility of parts
            player.children.forEach(child => {
                if (child.name === 'hidingBox') {
                    child.visible = player.userData.isHiding;
                } else {
                    child.visible = !player.userData.isHiding;
                }
            });

            // Adjust Speed
            player.userData.speed = player.userData.isHiding ? 0.1 : 0.3;
        };

        // --- MAIN LOOP ---
        function animate() {
            requestAnimationFrame(animate);

            if (Cutscene.active) return; // Don't run game logic during cutscene

            // 1. Movement
            if (window.joystick && window.joystick.active) {
                const moveX = window.joystick.x; 
                const moveY = window.joystick.y;
                const angle = rCam.theta;
                
                const fX = Math.sin(angle); const fZ = Math.cos(angle);
                const rX = Math.sin(angle+Math.PI/2); const rZ = Math.cos(angle+Math.PI/2);
                
                const dx = (rX * moveX) + (fX * moveY);
                const dz = (rZ * moveX) + (fZ * moveY);
                
                // Simple Wall Collision Check (Future improvement: Raycasting)
                player.position.x += dx * player.userData.speed;
                player.position.z += dz * player.userData.speed;
                player.rotation.y = Math.atan2(dx, dz);
            }

            // 2. Camera Follow
            rCam.update(player.position);

            // 3. Blue AI
            const dist = player.position.distanceTo(blue.position);
            
            // If hiding, Blue can't see you unless VERY close
            const detectionRange = player.userData.isHiding ? 5 : 40; 

            if(dist < detectionRange) {
                // CHASE
                blue.lookAt(player.position);
                blue.position.z += Math.cos(blue.rotation.y) * 0.15;
                blue.position.x += Math.sin(blue.rotation.y) * 0.15;

                if (dist < 4) {
                    // Caught
                    gameActive = false;
                    document.getElementById('game-over').style.display = 'flex';
                    document.getElementById('ui-layer').style.display = 'none';
                    document.getElementById('joystick-zone').style.display = 'none';
                }
            } else {
                // IDLE (Spin slowly)
                blue.rotation.y += 0.01;
            }

            // 4. Collectibles
            boxes.forEach((box, index) => {
                box.rotation.y += 0.05;
                box.position.y = box.userData.yStart + Math.sin(Date.now() * 0.005) * 0.5; // Float
                
                if (player.position.distanceTo(box.position) < 4) {
                    scene.remove(box);
                    boxes.splice(index, 1);
                    collected++;
                    document.getElementById('score').innerText = collected;
                    if(collected === 5) { alert("YOU SURVIVED!"); location.href="roblox.html"; }
                }
            });

            renderer.render(scene, camera);
        }
        animate();

        window.addEventListener('resize', () => { camera.aspect = window.innerWidth/window.innerHeight; camera.updateProjectionMatrix(); renderer.setSize(window.innerWidth, window.innerHeight); });
    </script>
</body>
</html>
