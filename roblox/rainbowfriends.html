<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Rainbow Friends</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="roblox-joystick.js"></script>
    <script src="roblox-cam.js"></script>

    <style>
        body { margin: 0; overflow: hidden; background: #000; }
        #game-container { position: relative; width: 100%; height: 100vh; }
        
        #touch-layer { position: absolute; top:0; left:0; width:100%; height:100%; z-index: 10; }
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 20; }

        .hud { position: absolute; top: 20px; width: 100%; text-align: center; color: white; font-size: 24px; font-weight: bold; text-shadow: 0 0 10px #000; }
        .exit-btn { position: absolute; top: 10px; left: 10px; pointer-events: auto; background: rgba(255,255,255,0.2); color: white; padding: 8px 12px; border-radius: 8px; text-decoration: none; font-weight: bold; }

        /* JOYSTICK */
        #joystick-zone { position: absolute; bottom: 50px; left: 30px; width: 100px; height: 100px; background: rgba(255, 255, 255, 0.1); border: 2px solid rgba(255, 255, 255, 0.3); border-radius: 50%; pointer-events: auto; z-index: 30; }
        #joystick-knob { position: absolute; top: 50%; left: 50%; width: 40px; height: 40px; background: rgba(255, 255, 255, 0.8); border-radius: 50%; transform: translate(-50%, -50%); pointer-events: none; }

        /* GAME OVER SCREEN */
        #game-over {
            display: none; /* Hidden by default */
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 50;
            flex-direction: column; justify-content: center; align-items: center;
            color: white; pointer-events: auto;
        }
        .fail-text { font-size: 40px; font-weight: bold; color: #ff4757; margin-bottom: 20px; }
        .retry-btn { padding: 15px 40px; font-size: 20px; background: white; border: none; border-radius: 30px; cursor: pointer; font-weight: bold; }
        .retry-btn:active { transform: scale(0.95); background: #ddd; }
    </style>
</head>
<body>

    <div id="game-container">
        <div id="touch-layer"></div>
        
        <div id="ui-layer">
            <a href="roblox.html" class="exit-btn">Exit</a>
            <div class="hud">Cubes: <span id="score">0</span>/5</div>
        </div>

        <div id="game-over">
            <div class="fail-text">CAUGHT!</div>
            <button class="retry-btn" onclick="location.reload()">Try Again</button>
        </div>

        <div id="joystick-zone"><div id="joystick-knob"></div></div>
    </div>

    <script>
        const container = document.getElementById('game-container');
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x111111);
        scene.fog = new THREE.Fog(0x111111, 10, 50);

        const camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer();
        renderer.setSize(window.innerWidth, window.innerHeight);
        container.insertBefore(renderer.domElement, document.getElementById('touch-layer'));

        const rCam = new RobloxCamera(camera, document.getElementById('touch-layer'));

        const light = new THREE.PointLight(0xffffff, 1, 100); light.position.set(0, 20, 0); scene.add(light);
        scene.add(new THREE.AmbientLight(0x404040));

        const floor = new THREE.Mesh(new THREE.PlaneGeometry(200, 200), new THREE.MeshStandardMaterial({ color: 0x333333 }));
        floor.rotation.x = -Math.PI / 2; scene.add(floor);

        const player = { active: true };
        const playerMesh = new THREE.Mesh(new THREE.BoxGeometry(1.5, 3, 1.5), new THREE.MeshStandardMaterial({ color: 0x00ff00 }));
        playerMesh.position.y = 1.5; scene.add(playerMesh);

        const blue = new THREE.Group();
        const bBody = new THREE.Mesh(new THREE.CylinderGeometry(2, 2, 6, 12), new THREE.MeshStandardMaterial({ color: 0x0984e3 })); bBody.position.y = 3;
        const bEyeL = new THREE.Mesh(new THREE.SphereGeometry(0.5), new THREE.MeshBasicMaterial({color:0xffffff})); bEyeL.position.set(1, 5, 1.5);
        blue.add(bBody); blue.add(bEyeL);
        blue.position.set(30, 0, -30); scene.add(blue);

        let boxes = [];
        for(let i=0; i<5; i++) {
            const b = new THREE.Mesh(new THREE.BoxGeometry(2, 2, 2), new THREE.MeshStandardMaterial({color: 0xff9f43}));
            b.position.set((Math.random()-0.5)*80, 1, (Math.random()-0.5)*80); scene.add(b); boxes.push(b);
        }

        let collected = 0;

        function animate() {
            if (!player.active) return; // Stop loop on death
            requestAnimationFrame(animate);

            // Movement
            if (window.joystick && window.joystick.active) {
                const moveX = window.joystick.x; const moveY = window.joystick.y;
                const angle = rCam.theta;
                const fX = Math.sin(angle); const fZ = Math.cos(angle);
                const rX = Math.sin(angle+Math.PI/2); const rZ = Math.cos(angle+Math.PI/2);
                
                const dx = (rX * moveX) + (fX * moveY);
                const dz = (rZ * moveX) + (fZ * moveY);
                
                playerMesh.position.x += dx * 0.3;
                playerMesh.position.z += dz * 0.3;
                playerMesh.rotation.y = Math.atan2(dx, dz);
            }

            rCam.update(playerMesh.position);

            // AI
            const dist = playerMesh.position.distanceTo(blue.position);
            if(dist > 3) {
                blue.lookAt(playerMesh.position);
                blue.position.z += Math.cos(blue.rotation.y) * 0.12;
                blue.position.x += Math.sin(blue.rotation.y) * 0.12;
            } else {
                // CAUGHT!
                player.active = false;
                document.getElementById('game-over').style.display = 'flex';
                document.getElementById('ui-layer').style.display = 'none';
                document.getElementById('joystick-zone').style.display = 'none';
            }

            // Boxes
            for(let i=boxes.length-1; i>=0; i--) {
                if(playerMesh.position.distanceTo(boxes[i].position) < 3) {
                    scene.remove(boxes[i]); boxes.splice(i, 1); collected++;
                    document.getElementById('score').innerText = collected;
                    if(collected === 5) { alert("YOU SURVIVED!"); location.href="roblox.html"; }
                }
                boxes[i].rotation.y += 0.05;
            }
            renderer.render(scene, camera);
        }
        animate();
        window.addEventListener('resize', () => { camera.aspect = window.innerWidth/window.innerHeight; camera.updateProjectionMatrix(); renderer.setSize(window.innerWidth, window.innerHeight); });
    </script>
</body>
</html>
