<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>WebGodot v1.1</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://unpkg.com/three@0.128.0/examples/js/controls/TransformControls.js"></script>
    <script src="https://unpkg.com/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    
    <script src="engine.js"></script>

    <style>
        body { margin: 0; display: flex; height: 100vh; background: #1e1e1e; color: #ccc; font-family: 'Segoe UI', sans-serif; overflow: hidden; }
        
        #layout { display: grid; grid-template-columns: 250px 1fr 300px; grid-template-rows: 40px 1fr 150px 200px; width: 100%; height: 100%; }
        
        #toolbar { grid-column: 1 / 4; background: #2d2d2d; display: flex; align-items: center; padding: 0 10px; border-bottom: 1px solid #111; gap: 10px; }
        #sidebar-left { grid-row: 2 / 5; background: #252526; border-right: 1px solid #111; display: flex; flex-direction: column; }
        #viewport { grid-row: 2 / 4; position: relative; background: #000; overflow: hidden; }
        #console-panel { grid-column: 2 / 3; grid-row: 4 / 5; background: #111; border-top: 1px solid #333; overflow-y: auto; font-family: monospace; padding: 5px; }
        #sidebar-right { grid-row: 2 / 5; background: #252526; border-left: 1px solid #111; padding: 10px; overflow-y: auto; }
        
        /* UI COMPONENTS */
        .panel-header { background: #3c3c3c; padding: 5px 10px; font-weight: bold; font-size: 11px; text-transform: uppercase; color: #aaa; }
        .btn { padding: 6px 12px; border: none; border-radius: 3px; cursor: pointer; font-weight: bold; color: white; font-size: 12px; display: flex; align-items: center; gap: 5px; }
        .btn-play { background: #388e3c; } .btn-stop { background: #d32f2f; }
        .btn-tool { background: #444; } .btn-tool.active { background: #007acc; }
        .btn-save { background: #e67e22; margin-left: auto; }
        
        /* CREATE NODE MENU */
        #create-node-area { padding: 10px; border-top: 1px solid #333; background: #1e1e1e; }
        select { width: 100%; background: #333; color: white; padding: 5px; border: 1px solid #444; margin-bottom: 5px; }
        
        .tree-item { padding: 4px 8px; cursor: pointer; font-size: 13px; display: flex; align-items: center; }
        .tree-item:hover { background: #2a2d2e; } .tree-item.active { background: #37373d; border-left: 3px solid #007acc; }
        
        .prop-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px; font-size: 12px; }
        input { background: #3c3c3c; border: 1px solid #333; color: white; padding: 4px; border-radius: 2px; }
        textarea { width: 100%; height: 100%; background: #1e1e1e; color: #9cdcfe; border: none; padding: 10px; resize: none; outline: none; }
        
        .log-entry { margin: 2px 0; border-bottom: 1px solid #222; }
        .log-info { color: #ccc; } .log-error { color: #ff5252; } .log-success { color: #69f0ae; }
    </style>
</head>
<body>

    <div id="layout">
        <div id="toolbar">
            <button class="btn btn-play" onclick="togglePlay(true)">‚ñ∂</button>
            <button class="btn btn-stop" onclick="togglePlay(false)">‚èπ</button>
            <div style="width: 20px;"></div>
            <button class="btn btn-tool" onclick="setGizmo('translate')">Move</button>
            <button class="btn btn-tool" onclick="setGizmo('rotate')">Rotate</button>
            <button class="btn btn-tool" onclick="setGizmo('scale')">Scale</button>
            <button class="btn btn-save" onclick="Game.saveScene()">üíæ Save</button>
            <button class="btn btn-tool" onclick="Game.loadScene()">üìÇ Load</button>
        </div>

        <div id="sidebar-left">
            <div class="panel-header">Scene</div>
            <div id="scene-tree" style="flex-grow:1; padding:5px;"></div>
            
            <div id="create-node-area">
                <div class="panel-header" style="background:none; padding-left:0;">Create Node</div>
                <select id="node-type-select">
                    </select>
                <button class="btn btn-tool" style="width:100%; justify-content:center;" onclick="spawnSelectedNode()">+ Add Node</button>
            </div>
        </div>

        <div id="viewport">
            <div id="game-canvas" style="width:100%; height:100%;"></div>
        </div>

        <div id="console-panel">
            <div style="color:#666; font-size:11px; margin-bottom:5px;">Console Output</div>
            <div id="console-logs"></div>
        </div>

        <div id="sidebar-right">
            <div class="panel-header">Properties</div>
            <div id="inspector-content" style="margin-bottom: 20px;"></div>
            <div class="panel-header">Script</div>
            <textarea id="code-editor" style="height: 300px;" placeholder="// Script..."></textarea>
        </div>
    </div>

    <script>
        // 1. INIT
        const canvasContainer = document.getElementById('game-canvas');
        Game.init(canvasContainer);

        // 2. TOOLS
        const orbit = new THREE.OrbitControls(Game.camera, Game.renderer.domElement);
        const gizmo = new THREE.TransformControls(Game.camera, Game.renderer.domElement);
        gizmo.setMode('translate');
        Game.scene.add(gizmo);

        gizmo.addEventListener('change', () => {
            if (selectedNode && selectedNode.sceneObj) {
                const o = selectedNode.sceneObj;
                selectedNode.export.x = o.position.x;
                selectedNode.export.y = o.position.y;
                selectedNode.export.z = o.position.z;
                selectedNode.export.rx = o.rotation.x;
                selectedNode.export.ry = o.rotation.y;
                selectedNode.export.rz = o.rotation.z;
                selectedNode.export.sx = o.scale.x;
                selectedNode.export.sy = o.scale.y;
                selectedNode.export.sz = o.scale.z;
                refreshInspector();
            }
        });
        gizmo.addEventListener('dragging-changed', (e) => orbit.enabled = !e.value);

        // 3. EDITOR STATE
        let selectedNode = null;

        document.getElementById('code-editor').addEventListener('input', (e) => {
            if (selectedNode) selectedNode.script = e.target.value;
        });

        Game.onLog = (msg, type) => {
            const div = document.createElement('div');
            div.className = `log-entry log-${type}`;
            div.innerText = `> ${msg}`;
            const logPanel = document.getElementById('console-logs');
            logPanel.appendChild(div);
            logPanel.scrollTop = logPanel.scrollHeight;
        };

        // 4. POPULATE NODE TYPES
        // This list matches the classes you defined in engine.js
        const nodeTypes = [
            "Node",
            "CubeObj", 
            "LookAtModifier3D", 
            "SpringBoneSimulator3D", 
            "RetargetModifier3D",
            "SkeletonModifier3D"
        ];
        
        const typeSelect = document.getElementById('node-type-select');
        nodeTypes.forEach(type => {
            const opt = document.createElement('option');
            opt.value = type;
            opt.innerText = type;
            typeSelect.appendChild(opt);
        });

        function spawnSelectedNode() {
            const type = typeSelect.value;
            let newNode;

            // Simple Factory
            if (type === "CubeObj") newNode = new CubeObj("Cube");
            else if (type === "LookAtModifier3D") newNode = new LookAtModifier3D("LookAt");
            else if (type === "SpringBoneSimulator3D") newNode = new SpringBoneSimulator3D("SpringBone");
            else if (type === "RetargetModifier3D") newNode = new RetargetModifier3D("Retarget");
            else if (type === "SkeletonModifier3D") newNode = new SkeletonModifier3D("SkeletonMod");
            else newNode = new Node("Node");

            // Unique Name
            newNode.name += "_" + Math.floor(Math.random()*100);

            // Add to selected parent or root
            const parent = selectedNode || Game.root;
            parent.add_child(newNode);
            
            selectNode(newNode);
        }

        window.Editor = {
            refreshTree: function() {
                const tree = document.getElementById('scene-tree');
                tree.innerHTML = "";
                const build = (node, depth) => {
                    const div = document.createElement('div');
                    div.className = 'tree-item';
                    if (selectedNode === node) div.classList.add('active');
                    div.style.paddingLeft = (depth * 15 + 10) + "px";
                    
                    // Icon logic
                    let icon = "‚ö™";
                    if (node.constructor.name.includes("Cube")) icon = "üì¶";
                    if (node.constructor.name.includes("Modifier")) icon = "üîß";
                    
                    div.innerText = icon + " " + node.name;
                    div.onclick = () => selectNode(node);
                    tree.appendChild(div);
                    node.children.forEach(c => build(c, depth + 1));
                };
                build(Game.root, 0);
            }
        };

        function selectNode(node) {
            selectedNode = node;
            window.Editor.refreshTree();
            
            if (node.sceneObj) gizmo.attach(node.sceneObj);
            else gizmo.detach();

            document.getElementById('code-editor').value = node.script || "";
            refreshInspector();
        }
        
        function setGizmo(mode) { gizmo.setMode(mode); }

        function refreshInspector() {
            const insp = document.getElementById('inspector-content');
            insp.innerHTML = "";
            if(!selectedNode) return;
            const node = selectedNode;

            // Name
            const nameRow = document.createElement('div'); nameRow.className = 'prop-row';
            nameRow.innerHTML = "<span>Name</span>";
            const nameIn = document.createElement('input'); nameIn.type="text"; nameIn.value=node.name;
            nameIn.onchange=(e)=>{ node.name=e.target.value; window.Editor.refreshTree(); };
            nameRow.appendChild(nameIn); insp.appendChild(nameRow);

            // Generic Properties from 'export'
            for (const key in node.export) {
                const val = node.export[key];
                const row = document.createElement('div'); row.className = 'prop-row';
                row.innerHTML = `<span>${key}</span>`;
                
                let input;
                if (typeof val === 'boolean') {
                    input = document.createElement('input'); input.type="checkbox"; input.checked = val;
                    input.onchange = (e) => { node.export[key] = e.target.checked; updateNodeVisuals(node); };
                } else if (typeof val === 'string' && val.startsWith("#")) {
                    input = document.createElement('input'); input.type="color"; input.value = val;
                    input.onchange = (e) => { node.export[key] = e.target.value; updateNodeVisuals(node); };
                } else if (typeof val === 'number') {
                    input = document.createElement('input'); input.type="number"; input.step="0.1"; input.value = val;
                    input.onchange = (e) => { node.export[key] = parseFloat(e.target.value); updateNodeVisuals(node); };
                } else {
                    input = document.createElement('input'); input.type="text"; input.value = val;
                    input.onchange = (e) => { node.export[key] = e.target.value; updateNodeVisuals(node); };
                }
                
                row.appendChild(input);
                insp.appendChild(row);
            }
        }

        function updateNodeVisuals(node) {
            // Force a single frame update to see changes immediately in Editor
            node._process(0);
        }

        function togglePlay(play) {
            Game.running = play;
            if(play) {
                gizmo.detach();
                Game.log("Game Started...", "info");
            } else {
                if(selectedNode && selectedNode.sceneObj) gizmo.attach(selectedNode.sceneObj);
                Game.log("Game Stopped.", "info");
                Game.loadScene(); 
            }
        }

        // Init
        Game.log("Editor Ready.", "success");
        window.Editor.refreshTree();
    </script>
</body>
</html>
