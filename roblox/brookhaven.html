<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Brookhaven RP</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="roblox-joystick.js"></script>
    <script src="roblox-cam.js"></script>

    <style>
        body { margin: 0; overflow: hidden; background: #87CEEB; user-select: none; font-family: 'Segoe UI', sans-serif; }
        #game-container { position: relative; width: 100%; height: 100vh; }
        
        #touch-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; }
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 20; }

        /* UI */
        .rp-menu { position: absolute; top: 60px; left: 10px; display: flex; flex-direction: column; gap: 10px; pointer-events: auto; }
        .rp-btn { background: #00b06f; border: 2px solid rgba(255,255,255,0.2); color: white; padding: 10px; border-radius: 8px; cursor: pointer; font-weight: bold; text-align: left; }
        .exit-btn { position: absolute; top: 10px; left: 10px; pointer-events: auto; background: rgba(0,0,0,0.4); color: white; padding: 8px 12px; border-radius: 8px; text-decoration: none; font-weight: bold; }

        /* JOYSTICK */
        #joystick-zone { position: absolute; bottom: 50px; left: 30px; width: 100px; height: 100px; background: rgba(255, 255, 255, 0.1); border: 2px solid rgba(255, 255, 255, 0.3); border-radius: 50%; pointer-events: auto; z-index: 30; }
        #joystick-knob { position: absolute; top: 50%; left: 50%; width: 40px; height: 40px; background: rgba(255, 255, 255, 0.8); border-radius: 50%; transform: translate(-50%, -50%); pointer-events: none; }

        #toast { position: absolute; top: 100px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.8); color: white; padding: 10px 20px; border-radius: 20px; opacity: 0; transition: opacity 0.5s; }
    </style>
</head>
<body>

    <div id="game-container">
        <div id="touch-layer"></div>
        <div id="ui-layer">
            <a href="roblox.html" class="exit-btn">‚¨Ö Exit</a>
            <div class="rp-menu">
                <button class="rp-btn" onclick="spawn('house')">üè° House</button>
                <button class="rp-btn" onclick="spawn('car')">üöó Car</button>
                <button class="rp-btn" onclick="spawn('pool')">üèä Pool</button>
            </div>
            <div id="toast">Message</div>
        </div>
        <div id="joystick-zone"><div id="joystick-knob"></div></div>
    </div>

    <script>
        const container = document.getElementById('game-container');
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x87CEEB);
        scene.fog = new THREE.Fog(0x87CEEB, 20, 100);

        const camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.shadowMap.enabled = true;
        container.insertBefore(renderer.domElement, document.getElementById('touch-layer'));

        const rCam = new RobloxCamera(camera, document.getElementById('touch-layer'));

        const ambient = new THREE.AmbientLight(0xffffff, 0.6); scene.add(ambient);
        const dirLight = new THREE.DirectionalLight(0xffffff, 0.8); dirLight.position.set(50, 100, 50); dirLight.castShadow = true; scene.add(dirLight);

        const ground = new THREE.Mesh(new THREE.PlaneGeometry(500, 500), new THREE.MeshLambertMaterial({ color: 0x55efc4 }));
        ground.rotation.x = -Math.PI/2; ground.receiveShadow = true; scene.add(ground);
        
        const road = new THREE.Mesh(new THREE.PlaneGeometry(40, 500), new THREE.MeshLambertMaterial({ color: 0x2d3436 }));
        road.rotation.x = -Math.PI/2; road.position.y = 0.05; scene.add(road);

        const player = new THREE.Group();
        const tColor = localStorage.getItem('av-torso') || '#f1c40f';
        const torso = new THREE.Mesh(new THREE.BoxGeometry(2, 3, 1.5), new THREE.MeshLambertMaterial({ color: tColor })); torso.position.y = 3;
        const head = new THREE.Mesh(new THREE.BoxGeometry(1.5, 1.5, 1.5), new THREE.MeshLambertMaterial({ color: '#ffeaa7' })); head.position.y = 5.5;
        player.add(torso); player.add(head); player.castShadow = true; scene.add(player);

        window.spawn = (t) => {
            const pos = player.position.clone();
            if(t==='house') { const h = new THREE.Mesh(new THREE.BoxGeometry(20,12,15), new THREE.MeshLambertMaterial({color:0xffffff})); h.position.set(pos.x+15,6,pos.z); scene.add(h); showToast("House!"); }
            if(t==='car') { const c = new THREE.Mesh(new THREE.BoxGeometry(6,2,10), new THREE.MeshLambertMaterial({color:0xd63031})); c.position.set(pos.x-5,1.5,pos.z); scene.add(c); showToast("Car!"); }
            if(t==='pool') { const p = new THREE.Mesh(new THREE.CylinderGeometry(8,8,0.5,16), new THREE.MeshLambertMaterial({color:0x00a8ff})); p.position.set(pos.x+15,0.1,pos.z+15); scene.add(p); showToast("Pool!"); }
        };
        function showToast(m) { const t=document.getElementById('toast'); t.innerText=m; t.style.opacity=1; setTimeout(()=>t.style.opacity=0, 2000); }

        function animate() {
            requestAnimationFrame(animate);
            
            // NEW JOYSTICK LOGIC
            if (window.joystick && window.joystick.active) {
                const moveX = window.joystick.x;
                const moveY = window.joystick.y;
                
                const angle = rCam.theta;
                const fX = Math.sin(angle); const fZ = Math.cos(angle);
                const rX = Math.sin(angle + Math.PI/2); const rZ = Math.cos(angle + Math.PI/2);
                
                const dx = (rX * moveX) + (fX * moveY);
                const dz = (rZ * moveX) + (fZ * moveY);
                
                player.position.x += dx * 0.4;
                player.position.z += dz * 0.4;
                player.rotation.y = Math.atan2(dx, dz);
            }

            rCam.update(player.position);
            renderer.render(scene, camera);
        }
        animate();
        window.addEventListener('resize', () => { camera.aspect = window.innerWidth/window.innerHeight; camera.updateProjectionMatrix(); renderer.setSize(window.innerWidth, window.innerHeight); });
    </script>
</body>
</html>
