<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Brookhaven RP</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="roblox-joystick.js"></script>
    <script src="roblox-cam.js"></script>

    <style>
        body { margin: 0; overflow: hidden; background: #87CEEB; user-select: none; font-family: 'Segoe UI', sans-serif; }
        #game-container { position: relative; width: 100%; height: 100vh; }
        
        /* LAYERS */
        #touch-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; }
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 20; }

        /* UI ELEMENTS */
        .rp-menu {
            position: absolute; top: 60px; left: 10px;
            display: flex; flex-direction: column; gap: 10px; pointer-events: auto;
        }
        .rp-btn {
            background: linear-gradient(135deg, #00b06f, #009e60);
            border: 2px solid rgba(255,255,255,0.2); color: white;
            padding: 10px 15px; border-radius: 8px; cursor: pointer;
            font-weight: bold; box-shadow: 0 4px 6px rgba(0,0,0,0.2);
            text-align: left; min-width: 120px;
        }
        .rp-btn:active { transform: scale(0.95); }

        .exit-btn {
            position: absolute; top: 10px; left: 10px; pointer-events: auto;
            background: rgba(0,0,0,0.4); color: white; padding: 8px 12px;
            border-radius: 8px; text-decoration: none; font-weight: bold;
            backdrop-filter: blur(4px);
        }

        /* JOYSTICK (Matches 99nights style) */
        #joystick-zone {
            position: absolute; bottom: 80px; left: 40px;
            width: 100px; height: 100px;
            background: rgba(255, 255, 255, 0.1); border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%; pointer-events: auto; z-index: 30;
        }
        #joystick-knob {
            position: absolute; top: 50%; left: 50%;
            width: 40px; height: 40px;
            background: rgba(255, 255, 255, 0.8); border-radius: 50%;
            transform: translate(-50%, -50%); pointer-events: none;
        }

        /* TOAST NOTIFICATION */
        #toast {
            position: absolute; top: 100px; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.8); color: white; padding: 10px 20px;
            border-radius: 20px; opacity: 0; transition: opacity 0.5s;
            pointer-events: none; font-size: 14px; text-align: center;
        }
    </style>
</head>
<body>

    <div id="game-container">
        <div id="touch-layer"></div>

        <div id="ui-layer">
            <a href="roblox.html" class="exit-btn">‚¨Ö Exit</a>
            
            <div class="rp-menu">
                <button class="rp-btn" onclick="spawn('house')">üè° Spawn House</button>
                <button class="rp-btn" onclick="spawn('car')">üöó Spawn Car</button>
                <button class="rp-btn" onclick="spawn('pool')">üèä Spawn Pool</button>
            </div>

            <div id="toast">Message</div>
        </div>

        <div id="joystick-zone"><div id="joystick-knob"></div></div>
    </div>

    <script>
        // --- SCENE SETUP ---
        const container = document.getElementById('game-container');
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x87CEEB);
        scene.fog = new THREE.Fog(0x87CEEB, 20, 100);

        const camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.shadowMap.enabled = true;
        renderer.shadowMap.type = THREE.PCFSoftShadowMap;
        container.insertBefore(renderer.domElement, document.getElementById('touch-layer'));

        // *** INIT ROBLOX CAMERA ***
        const rCam = new RobloxCamera(camera, document.getElementById('touch-layer'));

        // LIGHTING
        const ambient = new THREE.AmbientLight(0xffffff, 0.6); scene.add(ambient);
        const dirLight = new THREE.DirectionalLight(0xffffff, 0.8);
        dirLight.position.set(50, 100, 50); dirLight.castShadow = true;
        dirLight.shadow.mapSize.width = 2048; dirLight.shadow.mapSize.height = 2048;
        scene.add(dirLight);

        // CITY GENERATION
        // Grass
        const ground = new THREE.Mesh(new THREE.PlaneGeometry(500, 500), new THREE.MeshLambertMaterial({ color: 0x55efc4 }));
        ground.rotation.x = -Math.PI / 2; ground.receiveShadow = true; scene.add(ground);
        
        // Roads
        const roadMat = new THREE.MeshLambertMaterial({ color: 0x2d3436 });
        const road1 = new THREE.Mesh(new THREE.PlaneGeometry(40, 500), roadMat);
        road1.rotation.x = -Math.PI / 2; road1.position.y = 0.05; road1.receiveShadow = true; scene.add(road1);
        
        const road2 = new THREE.Mesh(new THREE.PlaneGeometry(500, 40), roadMat);
        road2.rotation.x = -Math.PI / 2; road2.position.y = 0.05; road2.receiveShadow = true; scene.add(road2);

        // PLAYER
        const player = new THREE.Group();
        // Colors from local storage or default
        const tColor = localStorage.getItem('av-torso') || '#f1c40f';
        const lColor = localStorage.getItem('av-leg') || '#2c3e50';
        
        const torso = new THREE.Mesh(new THREE.BoxGeometry(2, 3, 1.5), new THREE.MeshLambertMaterial({ color: tColor })); torso.position.y = 3;
        const head = new THREE.Mesh(new THREE.BoxGeometry(1.5, 1.5, 1.5), new THREE.MeshLambertMaterial({ color: '#ffeaa7' })); head.position.y = 5.5;
        const legL = new THREE.Mesh(new THREE.BoxGeometry(0.9, 1.5, 1), new THREE.MeshLambertMaterial({ color: lColor })); legL.position.set(-0.5, 0.75, 0);
        const legR = new THREE.Mesh(new THREE.BoxGeometry(0.9, 1.5, 1), new THREE.MeshLambertMaterial({ color: lColor })); legR.position.set(0.5, 0.75, 0);
        
        player.add(torso); player.add(head); player.add(legL); player.add(legR);
        player.castShadow = true; scene.add(player);

        // GAME LOGIC
        window.spawn = function(type) {
            const pos = player.position.clone();
            const offset = 15;
            
            if(type === 'house') {
                const h = new THREE.Group();
                const walls = new THREE.Mesh(new THREE.BoxGeometry(20, 12, 15), new THREE.MeshLambertMaterial({color: 0xffffff})); walls.position.y=6;
                const roof = new THREE.Mesh(new THREE.ConeGeometry(16, 6, 4), new THREE.MeshLambertMaterial({color: 0xe17055})); roof.position.y=15; roof.rotation.y=Math.PI/4;
                h.add(walls); h.add(roof);
                h.position.set(pos.x + offset, 0, pos.z); h.castShadow=true; scene.add(h);
                showToast("House Spawned!");
            }
            if(type === 'car') {
                const c = new THREE.Group();
                const body = new THREE.Mesh(new THREE.BoxGeometry(6, 2, 10), new THREE.MeshLambertMaterial({color: 0xd63031})); body.position.y=1.5;
                c.add(body);
                c.position.set(pos.x - 5, 0.5, pos.z); c.castShadow=true; scene.add(c);
                showToast("Car Spawned!");
            }
            if(type === 'pool') {
                 const p = new THREE.Mesh(new THREE.CylinderGeometry(8, 8, 0.5, 16), new THREE.MeshLambertMaterial({color:0x00a8ff}));
                 p.position.set(pos.x + offset, 0.1, pos.z + offset); scene.add(p);
                 showToast("Pool Spawned!");
            }
        };

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg; t.style.opacity = 1;
            setTimeout(() => t.style.opacity = 0, 2000);
        }

        // MAIN LOOP
        function animate() {
            requestAnimationFrame(animate);
            
            // Movement Logic (Camera Relative)
            if (window.joystick && window.joystick.active) {
                const moveX = window.joystick.getX(); 
                const moveY = window.joystick.getY();
                
                // Get Camera Angle
                const angle = rCam.theta;
                const fX = Math.sin(angle); const fZ = Math.cos(angle);
                const rX = Math.sin(angle + Math.PI/2); const rZ = Math.cos(angle + Math.PI/2);
                
                // Calculate direction
                const dx = (rX * moveX) + (fX * moveY);
                const dz = (rZ * moveX) + (fZ * moveY);
                
                player.position.x += dx * 0.4;
                player.position.z += dz * 0.4;
                player.rotation.y = Math.atan2(dx, dz);
            }

            // Update Camera Position
            rCam.update(player.position);
            
            renderer.render(scene, camera);
        }
        animate();

        window.addEventListener('resize', () => { camera.aspect = window.innerWidth/window.innerHeight; camera.updateProjectionMatrix(); renderer.setSize(window.innerWidth, window.innerHeight); });
    </script>
</body>
</html>
