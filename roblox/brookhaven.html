<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Brookhaven RP 3D</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="roblox-joystick.js"></script>
    <script src="roblox-cam.js"></script> <style>
        body { overflow: hidden; background: #87CEEB; }
        #game-container { position: relative; width: 100%; height: 100vh; }
        #touch-layer { position: absolute; top:0; left:0; width:100%; height:100%; z-index: 5; }
        #ui-layer { position: absolute; top: 50px; left: 10px; pointer-events: none; z-index: 10; }
        .rp-btn { pointer-events: auto; background: #00b06f; border: none; color: white; padding: 10px; margin-bottom: 5px; border-radius: 5px; display:block; cursor: pointer; }
        .exit-link { position:absolute; top:10px; left:10px; z-index:20; color:white; font-weight:bold; text-decoration:none; background:rgba(0,0,0,0.3); padding:5px 10px; border-radius:5px; }
    </style>
</head>
<body>
    <div id="game-container">
        <div id="touch-layer"></div>
        <a href="roblox.html" class="exit-link">‚¨Ö Exit</a>

        <div id="ui-layer">
            <button class="rp-btn" onclick="spawn('house')">üè° House</button>
            <button class="rp-btn" onclick="spawn('car')">üöó Car</button>
        </div>
    </div>

    <script>
        const container = document.getElementById('game-container');
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x87CEEB);

        const camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.shadowMap.enabled = true;
        container.insertBefore(renderer.domElement, document.getElementById('touch-layer'));

        // *** INIT CAMERA ***
        const rCam = new RobloxCamera(camera, document.getElementById('touch-layer'));

        scene.add(new THREE.AmbientLight(0xffffff, 0.6));
        const dirLight = new THREE.DirectionalLight(0xffffff, 0.8);
        dirLight.position.set(50, 100, 50); dirLight.castShadow = true; scene.add(dirLight);

        const ground = new THREE.Mesh(new THREE.PlaneGeometry(500, 500), new THREE.MeshLambertMaterial({ color: 0x55efc4 }));
        ground.rotation.x = -Math.PI / 2; ground.receiveShadow = true; scene.add(ground);
        
        const road = new THREE.Mesh(new THREE.PlaneGeometry(40, 500), new THREE.MeshLambertMaterial({ color: 0x2d3436 }));
        road.rotation.x = -Math.PI / 2; road.position.y = 0.05; scene.add(road);

        const player = new THREE.Group();
        const torso = new THREE.Mesh(new THREE.BoxGeometry(2, 3, 1.5), new THREE.MeshLambertMaterial({ color: localStorage.getItem('av-torso')||'#f1c40f' })); torso.position.y = 3;
        const head = new THREE.Mesh(new THREE.BoxGeometry(1.5, 1.5, 1.5), new THREE.MeshLambertMaterial({ color: '#ffeaa7' })); head.position.y = 5.5;
        player.add(torso); player.add(head); player.castShadow = true; scene.add(player);

        window.spawn = (t) => {
            if(t==='house') { const h = new THREE.Mesh(new THREE.BoxGeometry(12, 10, 12), new THREE.MeshLambertMaterial({color:0xe74c3c})); h.position.set(player.position.x + 15, 5, player.position.z); scene.add(h); }
            if(t==='car') { const c = new THREE.Mesh(new THREE.BoxGeometry(5, 2, 8), new THREE.MeshLambertMaterial({color:0x3498db})); c.position.set(player.position.x - 5, 1, player.position.z); scene.add(c); }
        };

        function animate() {
            requestAnimationFrame(animate);
            
            // Movement (Camera Relative)
            let dx = 0; let dz = 0;
            if (window.joystick && window.joystick.active) {
                const moveX = window.joystick.getX(); const moveY = window.joystick.getY();
                const angle = rCam.theta;
                const fX = Math.sin(angle); const fZ = Math.cos(angle);
                const rX = Math.sin(angle+Math.PI/2); const rZ = Math.cos(angle+Math.PI/2);
                dx = (rX * moveX) + (fX * moveY);
                dz = (rZ * moveX) + (fZ * moveY);
                
                player.position.x += dx * 0.4;
                player.position.z += dz * 0.4;
                player.rotation.y = Math.atan2(dx, dz);
            }

            // Update Camera
            rCam.update(player.position);
            renderer.render(scene, camera);
        }
        animate();
    </script>
</body>
</html>
