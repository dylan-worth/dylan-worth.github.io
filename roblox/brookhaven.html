<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Brookhaven RP 3D</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        body { overflow: hidden; }
        #game-container { position: relative; width: 100%; height: 80vh; background: #87CEEB; }
        
        /* RP UI Layer */
        #ui-layer { 
            position: absolute; 
            top: 10px; 
            left: 10px; 
            pointer-events: none; /* Let clicks pass through to canvas if needed */
        }
        
        .rp-menu {
            pointer-events: auto; 
            background: rgba(0,0,0,0.6); 
            padding: 10px; 
            border-radius: 8px; 
            margin-bottom: 10px;
            color: white;
            width: 150px;
        }

        .rp-btn {
            background: #00b06f;
            border: none;
            color: white;
            padding: 8px;
            width: 100%;
            margin-bottom: 5px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        /* Mobile Controls Bottom */
        #mobile-controls { 
            position: absolute; 
            bottom: 20px; 
            left: 50%; 
            transform: translateX(-50%); 
            z-index: 10; 
        }
    </style>
</head>
<body>
    <nav>
        <h1>BLOX</h1>
        <div class="nav-links"><a href="roblox.html">Exit Game</a></div>
    </nav>

    <div id="game-container">
        <div id="ui-layer">
            <div class="rp-menu">
                <strong>Roleplay Menu</strong><br><br>
                <button class="rp-btn" onclick="spawn('house')">üè° Spawn House</button>
                <button class="rp-btn" onclick="spawn('car')">üöó Spawn Car</button>
                <button class="rp-btn" onclick="setJob('Police')">üëÆ Job: Police</button>
                <button class="rp-btn" onclick="setJob('Doctor')">üë®‚Äç‚öïÔ∏è Job: Doctor</button>
            </div>
            <div style="color:white; font-weight:bold; text-shadow:1px 1px 0 #000;">
                Current Job: <span id="job-title">Unemployed</span>
            </div>
        </div>

        <div id="mobile-controls">
            <div style="display:grid; grid-template-columns: 60px 60px 60px; gap:5px;">
                <div></div>
                <div class="d-btn" ontouchstart="press('w')" ontouchend="release('w')">‚ñ≤</div>
                <div></div>
                <div class="d-btn" ontouchstart="press('a')" ontouchend="release('a')">‚óÄ</div>
                <div class="d-btn" ontouchstart="press('s')" ontouchend="release('s')">‚ñº</div>
                <div class="d-btn" ontouchstart="press('d')" ontouchend="release('d')">‚ñ∂</div>
            </div>
        </div>
    </div>

    <script>
        // --- 1. SCENE SETUP ---
        const container = document.getElementById('game-container');
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x87CEEB); // Sky Blue
        scene.fog = new THREE.Fog(0x87CEEB, 20, 100); // Soft fog for distance

        const camera = new THREE.PerspectiveCamera(60, container.clientWidth / container.clientHeight, 0.1, 1000);
        camera.position.set(0, 15, 20); // High angle camera

        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(container.clientWidth, container.clientHeight);
        renderer.shadowMap.enabled = true;
        container.appendChild(renderer.domElement);

        // --- 2. WORLD BUILDING ---
        // Lights
        const ambient = new THREE.AmbientLight(0xffffff, 0.6);
        scene.add(ambient);
        const dirLight = new THREE.DirectionalLight(0xffffff, 0.8);
        dirLight.position.set(50, 100, 50);
        dirLight.castShadow = true;
        scene.add(dirLight);

        // Grass Base
        const grassGeo = new THREE.PlaneGeometry(500, 500);
        const grassMat = new THREE.MeshLambertMaterial({ color: 0x55efc4 });
        const ground = new THREE.Mesh(grassGeo, grassMat);
        ground.rotation.x = -Math.PI / 2;
        ground.receiveShadow = true;
        scene.add(ground);

        // Roads
        function createRoad(x, z, w, h) {
            const geo = new THREE.PlaneGeometry(w, h);
            const mat = new THREE.MeshLambertMaterial({ color: 0x2d3436 });
            const road = new THREE.Mesh(geo, mat);
            road.rotation.x = -Math.PI / 2;
            road.position.set(x, 0.05, z); // Slightly above grass
            road.receiveShadow = true;
            scene.add(road);
        }
        createRoad(0, 0, 20, 500); // Main N/S Road
        createRoad(0, 0, 500, 20); // Main E/W Road

        // --- 3. PLAYER AVATAR ---
        const player = new THREE.Group();
        
        // Torso (Colors loaded from Avatar Editor)
        const torsoColor = localStorage.getItem('av-torso') || '#ffaa00';
        const legColor = localStorage.getItem('av-leg') || '#2d3436';
        
        const bodyGeo = new THREE.BoxGeometry(2, 2.5, 1);
        const bodyMat = new THREE.MeshLambertMaterial({ color: torsoColor });
        const body = new THREE.Mesh(bodyGeo, bodyMat);
        body.position.y = 2.75;
        
        // Head
        const headGeo = new THREE.BoxGeometry(1.2, 1.2, 1.2);
        const headMat = new THREE.MeshLambertMaterial({ color: 0xffe0bd }); // Skin tone
        const head = new THREE.Mesh(headGeo, headMat);
        head.position.y = 4.6;

        // Legs
        const legGeo = new THREE.BoxGeometry(0.9, 1.5, 1);
        const legMat = new THREE.MeshLambertMaterial({ color: legColor });
        const legL = new THREE.Mesh(legGeo, legMat); legL.position.set(-0.5, 0.75, 0);
        const legR = new THREE.Mesh(legGeo, legMat); legR.position.set(0.5, 0.75, 0);

        player.add(body);
        player.add(head);
        player.add(legL);
        player.add(legR);
        player.castShadow = true;
        scene.add(player);

        // --- 4. GAME LOGIC ---
        let keys = {};
        let carActive = false;
        let carMesh = null;

        // Inputs
        window.addEventListener('keydown', e => keys[e.key] = true);
        window.addEventListener('keyup', e => keys[e.key] = false);
        window.press = (k) => keys[k] = true;
        window.release = (k) => keys[k] = false;

        // Functions exposed to buttons
        window.spawn = (type) => {
            if (type === 'house') {
                // Spawn house at a fixed location nearby
                const hGroup = new THREE.Group();
                const walls = new THREE.Mesh(new THREE.BoxGeometry(15, 10, 15), new THREE.MeshLambertMaterial({color: 0xffffff}));
                walls.position.y = 5;
                const roof = new THREE.Mesh(new THREE.ConeGeometry(12, 5, 4), new THREE.MeshLambertMaterial({color: 0xd63031}));
                roof.position.y = 12.5;
                roof.rotation.y = Math.PI/4;
                hGroup.add(walls);
                hGroup.add(roof);
                hGroup.position.set(player.position.x + 20, 0, player.position.z);
                scene.add(hGroup);
                alert("House claimed nearby!");
            }
            if (type === 'car') {
                if (carActive) {
                    player.remove(carMesh);
                    carActive = false;
                    player.position.y = 0; // Reset height
                } else {
                    const carG = new THREE.Group();
                    const body = new THREE.Mesh(new THREE.BoxGeometry(4, 1.5, 6), new THREE.MeshLambertMaterial({color: 0x74b9ff}));
                    body.position.y = 1;
                    const wheels = new THREE.Mesh(new THREE.BoxGeometry(4.2, 0.5, 3), new THREE.MeshLambertMaterial({color: 0x000000}));
                    wheels.position.y = 0.5;
                    carG.add(body);
                    carG.add(wheels);
                    
                    carMesh = carG;
                    player.add(carMesh);
                    player.position.y = 1; // Sit inside
                    carActive = true;
                }
            }
        };

        window.setJob = (jobName) => {
            document.getElementById('job-title').innerText = jobName;
        };

        function animate() {
            requestAnimationFrame(animate);

            // Movement speed
            let speed = carActive ? 0.8 : 0.3;

            if (keys['w']) player.position.z -= speed;
            if (keys['s']) player.position.z += speed;
            if (keys['a']) player.position.x -= speed;
            if (keys['d']) player.position.x += speed;

            // Camera Follow
            camera.position.x = player.position.x;
            camera.position.z = player.position.z + 25;
            camera.position.y = 15;
            camera.lookAt(player.position);

            renderer.render(scene, camera);
        }

        // Resize
        window.addEventListener('resize', () => {
            camera.aspect = container.clientWidth / container.clientHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(container.clientWidth, container.clientHeight);
        });

        animate();
    </script>
</body>
</html>
