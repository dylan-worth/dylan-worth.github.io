<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Open881 3D Mobile</title>
    <style>
        body { margin: 0; overflow: hidden; font-family: 'Trebuchet MS', sans-serif; background: #000; touch-action: none; }
        
        /* UI LAYERS */
        #game-ui { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
        
        /* MOBILE SIDEBAR */
        #sidebar-toggle {
            position: absolute; top: 10px; right: 10px; pointer-events: auto;
            background: #1a2a36; border: 2px solid #5a7b8f; color: #ffd700;
            width: 40px; height: 40px; border-radius: 5px; font-size: 24px;
            display: flex; align-items: center; justify-content: center; z-index: 20;
        }

        #mobile-sidebar {
            position: absolute; top: 0; right: 0; width: 250px; height: 100%;
            background: rgba(8, 30, 43, 0.95); border-left: 3px solid #3c4b57;
            transform: translateX(100%); transition: transform 0.3s ease;
            pointer-events: auto; z-index: 10; display: flex; flex-direction: column;
        }
        #mobile-sidebar.open { transform: translateX(0); }

        .panel-header { background: #152936; padding: 15px; color: #ffd700; font-weight: bold; border-bottom: 1px solid #5a7b8f; }
        
        .spell-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; padding: 15px; }
        .spell-icon {
            background: #2b3945; border: 1px solid #5a7b8f; aspect-ratio: 1;
            display: flex; align-items: center; justify-content: center;
            font-size: 20px; cursor: pointer; border-radius: 5px;
        }
        .spell-icon:hover { border-color: #00ccff; background: #3c4b57; }

        .tele-list { padding: 15px; display: flex; flex-direction: column; gap: 10px; }
        .tele-btn {
            background: #1a2a36; border: 1px solid #00ccff; color: #00ccff;
            padding: 10px; text-align: center; font-weight: bold;
        }

        /* CONTEXT TEXT */
        #context-text {
            position: absolute; top: 10px; left: 10px; 
            color: #00ff00; font-weight: bold; text-shadow: 1px 1px #000;
            font-size: 14px; pointer-events: none;
        }
    </style>
    
    <script type="importmap">
        { "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js" } }
    </script>
</head>
<body>

    <div id="game-ui">
        <div id="context-text">Tap to move...</div>
        
        <div id="sidebar-toggle" onclick="toggleSidebar()">‚ò∞</div>
        
        <div id="mobile-sidebar">
            <div class="panel-header">Spellbook</div>
            <div class="spell-grid">
                <div class="spell-icon" onclick="game.cast('home')">üè†</div>
                <div class="spell-icon" onclick="game.cast('alch')">üí∞</div>
                <div class="spell-icon" onclick="game.cast('barrage')">‚ùÑÔ∏è</div>
                <div class="spell-icon" onclick="game.cast('veng')">üíÄ</div>
                <div class="spell-icon" onclick="game.cast('heal')">‚ù§Ô∏è</div>
                <div class="spell-icon" onclick="game.cast('farm')">üå±</div>
            </div>

            <div class="panel-header">Teleports</div>
            <div class="tele-list">
                <div class="tele-btn" onclick="game.teleport('lumbridge')">Lumbridge</div>
                <div class="tele-btn" onclick="game.teleport('menaphos')">Menaphos</div>
                <div class="tele-btn" onclick="game.teleport('falador')">Falador</div>
            </div>
        </div>
    </div>

    <script>
        function toggleSidebar() {
            document.getElementById('mobile-sidebar').classList.toggle('open');
        }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { createBuilding, getColliders } from './buildings.js';
        import { createTree } from './foliage.js';
        import { loadLumbridge } from './lumbridge.js';
        import { loadMenaphos } from './menaphos.js';
        import { loadFalador } from './falador.js';

        class GameEngine {
            constructor() {
                this.scene = new THREE.Scene();
                this.scene.background = new THREE.Color(0x87CEEB);
                this.scene.fog = new THREE.Fog(0x87CEEB, 20, 80);

                this.camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
                this.renderer = new THREE.WebGLRenderer({ antialias: true });
                this.renderer.setSize(window.innerWidth, window.innerHeight);
                this.renderer.shadowMap.enabled = true;
                document.body.appendChild(this.renderer.domElement);

                // --- PLAYER SETUP ---
                this.player = this.createPlayerMesh();
                this.scene.add(this.player);
                this.targetPos = new THREE.Vector3(0, 0, 0);
                this.isMoving = false;
                this.moveSpeed = 0.15;

                // --- INPUTS ---
                this.raycaster = new THREE.Raycaster();
                this.mouse = new THREE.Vector2();

                // --- LOAD WORLD ---
                this.initLights();
                this.loadLocation('lumbridge'); // Start location

                // Listeners
                window.addEventListener('pointerdown', (e) => this.onPointerDown(e));
                window.addEventListener('resize', () => this.onResize());

                this.animate();
                window.game = this; // Expose for UI
            }

            createPlayerMesh() {
                const group = new THREE.Group();
                // Body
                const body = new THREE.Mesh(new THREE.BoxGeometry(0.8, 1.2, 0.5), new THREE.MeshStandardMaterial({ color: 0x555555 })); // Platebody
                body.position.y = 1.6;
                body.castShadow = true;
                group.add(body);
                // Head
                const head = new THREE.Mesh(new THREE.BoxGeometry(0.4, 0.5, 0.4), new THREE.MeshStandardMaterial({ color: 0xffccaa })); // Skin
                head.position.y = 2.5;
                group.add(head);
                // Cape
                const cape = new THREE.Mesh(new THREE.BoxGeometry(0.6, 1.0, 0.1), new THREE.MeshStandardMaterial({ color: 0xff0000 }));
                cape.position.set(0, 1.6, -0.3);
                group.add(cape);
                return group;
            }

            initLights() {
                const ambient = new THREE.AmbientLight(0xffffff, 0.5);
                this.scene.add(ambient);
                const sun = new THREE.DirectionalLight(0xffffff, 0.8);
                sun.position.set(50, 100, 50);
                sun.castShadow = true;
                this.scene.add(sun);
            }

            loadLocation(name) {
                // Clear old world objects (except player/lights)
                // (Simplified cleanup for demo)
                this.scene.children = this.scene.children.filter(c => c === this.player || c.type.includes('Light'));
                this.initLights(); // Re-add lights if wiped

                if(name === 'lumbridge') loadLumbridge(this.scene);
                if(name === 'menaphos') loadMenaphos(this.scene);
                if(name === 'falador') loadFalador(this.scene);

                // Reset player
                this.player.position.set(0, 0, 0);
                this.targetPos.set(0, 0, 0);
                this.isMoving = false;
                
                // Update Fog color based on location
                if(name === 'menaphos') {
                    this.scene.background.setHex(0xffeebb);
                    this.scene.fog.color.setHex(0xffeebb);
                } else {
                    this.scene.background.setHex(0x87CEEB);
                    this.scene.fog.color.setHex(0x87CEEB);
                }
            }

            teleport(loc) {
                this.loadLocation(loc);
                document.getElementById('sidebar-toggle').click(); // Close menu
                document.getElementById('context-text').innerText = "Teleported to " + loc;
            }

            cast(spell) {
                document.getElementById('context-text').innerText = "Casting " + spell + "...";
                // Add particle logic here
            }

            onPointerDown(event) {
                // Ignore clicks on UI
                if (event.target.id !== 'game-ui' && event.target.tagName !== 'CANVAS') return;

                this.mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
                this.mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;

                this.raycaster.setFromCamera(this.mouse, this.camera);
                const intersects = this.raycaster.intersectObjects(this.scene.children, true); // True = recursive

                for (let hit of intersects) {
                    // Ignore hitting the player itself
                    if (hit.object.parent === this.player) continue;
                    
                    // Clicked Ground?
                    this.targetPos.set(hit.point.x, 0, hit.point.z);
                    this.isMoving = true;
                    this.spawnMarker(hit.point);
                    break;
                }
            }

            spawnMarker(pos) {
                const marker = new THREE.Mesh(
                    new THREE.RingGeometry(0.2, 0.3, 8), 
                    new THREE.MeshBasicMaterial({ color: 0xffff00, side: THREE.DoubleSide })
                );
                marker.rotation.x = -Math.PI/2;
                marker.position.copy(pos);
                marker.position.y = 0.1;
                this.scene.add(marker);
                setTimeout(() => this.scene.remove(marker), 500);
            }

            checkCollision(nextPos) {
                const colliders = getColliders(); // From buildings.js
                // Simple box check
                const playerBox = new THREE.Box3().setFromCenterAndSize(nextPos, new THREE.Vector3(1, 2, 1));
                
                for(let box of colliders) {
                    if(playerBox.intersectsBox(box)) return true; // Collision detected
                }
                return false;
            }

            animate() {
                requestAnimationFrame(() => this.animate());

                if (this.isMoving) {
                    const dir = new THREE.Vector3().subVectors(this.targetPos, this.player.position);
                    const dist = dir.length();

                    if (dist < 0.2) {
                        this.isMoving = false;
                        this.player.position.y = 0; // Reset height
                    } else {
                        dir.normalize();
                        const step = dir.multiplyScalar(this.moveSpeed);
                        const nextPos = this.player.position.clone().add(step);

                        if(!this.checkCollision(nextPos)) {
                            this.player.position.copy(nextPos);
                            this.player.lookAt(this.targetPos.x, this.player.position.y, this.targetPos.z);
                            
                            // Bobbing Animation (Walking)
                            const time = Date.now() * 0.01;
                            this.player.position.y = Math.abs(Math.sin(time)) * 0.2; 
                        } else {
                            this.isMoving = false; // Stop if hit wall
                        }
                    }
                    
                    // Smooth Camera Follow
                    this.camera.position.lerp(new THREE.Vector3(this.player.position.x, 15, this.player.position.z + 12), 0.1);
                    this.camera.lookAt(this.player.position);
                }

                this.renderer.render(this.scene, this.camera);
            }
            
            onResize() {
                this.camera.aspect = window.innerWidth / window.innerHeight;
                this.camera.updateProjectionMatrix();
                this.renderer.setSize(window.innerWidth, window.innerHeight);
            }
        }

        new GameEngine();
    </script>
</body>
</html>
